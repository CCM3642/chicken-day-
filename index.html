<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crispy Chicken Management Command Center</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { 
      --primary: #d9534f; 
      --secondary: #5cb85c; 
      --warning: #f0ad4e; 
      --info: #5bc0de; 
      --light: #f4f4f9; 
      --dark: #333; 
      --white: #fff; 
      --border: #ddd; 
      --success-green: #28a745; 
      --danger-red: #dc3545;
      --card-bg: #ffffff;
      --card-shadow: 0 2px 10px rgba(0,0,0,0.1);
      --nav-bg: #2c3e50;
      --nav-hover: #34495e;
      --nav-active: #1a252f;
    }
    
    body { 
      font-family: 'Roboto', sans-serif; 
      background-color: var(--light); 
      color: var(--dark); 
      margin: 0; 
      padding: 0;
      overflow-x: hidden;
    }
    
    .container { 
      display: flex; 
      height: 100vh; 
    }
    
    /* Navigation Sidebar */
    .nav-sidebar {
      width: 220px;
      background-color: var(--nav-bg);
      color: var(--white);
      padding: 20px 0;
      display: flex;
      flex-direction: column;
    }
    
    .nav-header {
      text-align: center;
      padding: 0 15px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }
    
    .nav-header h1 {
      margin: 0;
      font-size: 1.4rem;
      color: var(--white);
    }
    
    .nav-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .nav-item {
      margin-bottom: 5px;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      transition: all 0.3s;
    }
    
    .nav-link:hover {
      background-color: var(--nav-hover);
      color: var(--white);
    }
    
    .nav-link.active {
      background-color: var(--nav-active);
      color: var(--white);
      border-left: 4px solid var(--primary);
    }
    
    .nav-link i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    
    /* Main Content */
    .main-container {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .content-header {
      background-color: var(--white);
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .content-title {
      font-size: 1.5rem;
      color: var(--primary);
      margin: 0;
    }
    
    .content-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: var(--white);
    }
    
    .btn-primary:hover {
      background-color: #c9302c;
    }
    
    .btn-info {
      background-color: var(--info);
      color: var(--white);
    }
    
    .btn-info:hover {
      background-color: #31b0d5;
    }
    
    .btn-warning {
      background-color: var(--warning);
      color: var(--white);
    }
    
    .btn-warning:hover {
      background-color: #ec971f;
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      color: var(--white);
    }
    
    .btn-secondary:hover {
      background-color: #4cae4c;
    }
    
    .content-body {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    
    /* Dashboard Section */
    .dashboard-section {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .dashboard-card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
      transition: transform 0.3s;
    }
    
    .dashboard-card:hover {
      transform: translateY(-5px);
    }
    
    .dashboard-card .icon {
      font-size: 2.5rem;
      margin-right: 15px;
    }
    
    .dashboard-card .content {
      flex-grow: 1;
    }
    
    .dashboard-card .value {
      font-size: 2rem;
      font-weight: 700;
      margin: 0;
      line-height: 1.2;
    }
    
    .dashboard-card .label {
      font-size: 1rem;
      color: #666;
      margin: 0;
    }
    
    .dashboard-card.branches .icon { color: var(--primary); }
    .dashboard-card.drivers .icon { color: var(--info); }
    .dashboard-card.managers .icon { color: var(--warning); }
    .dashboard-card.agents .icon { color: var(--secondary); }
    .dashboard-card.sales .icon { color: var(--success-green); }
    
    /* Data Sections */
    .data-section {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    
    .data-section.active {
      display: flex;
    }
    
    .section-controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    
    .search-box {
      width: 300px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 16px;
    }
    
    .data-table-container {
      flex-grow: 1;
      overflow-y: auto;
      background: var(--white);
      border-radius: 8px;
      box-shadow: var(--card-shadow);
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th, .data-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .data-table th {
      background-color: #f8f9fa;
      font-weight: 500;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .data-table tr:hover {
      background-color: #f8f9fa;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-active {
      background-color: rgba(40, 167, 69, 0.1);
      color: var(--success-green);
    }
    
    .status-inactive {
      background-color: rgba(220, 53, 69, 0.1);
      color: var(--danger-red);
    }
    
    .action-btn {
      background: none;
      border: none;
      color: var(--info);
      cursor: pointer;
      font-size: 1rem;
      margin: 0 3px;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.3s;
    }
    
    .action-btn:hover {
      background-color: rgba(91, 192, 222, 0.1);
    }
    
    .action-btn.delete {
      color: var(--danger-red);
    }
    
    .action-btn.delete:hover {
      background-color: rgba(220, 53, 69, 0.1);
    }
    
    /* Form Popup */
    .form-popup { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background-color: rgba(0,0,0,0.5); 
      z-index: 1000; 
      justify-content: center; 
      align-items: center;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .form-container { 
      background: var(--white); 
      padding: 30px; 
      border-radius: 8px; 
      width: 90%; 
      max-width: 800px; 
      max-height: 90vh; 
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: slideIn 0.3s;
    }
    
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .close-btn { 
      color: var(--dark); 
      float: right; 
      font-size: 28px; 
      font-weight: bold; 
      cursor: pointer;
      transition: color 0.3s;
    }
    
    .close-btn:hover { 
      color: var(--primary); 
    }
    
    .form-title {
      margin-top: 0;
      color: var(--primary);
    }
    
    form { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
      gap: 15px; 
    }
    
    .form-group { 
      display: flex; 
      flex-direction: column; 
    }
    
    .form-group.full-width { 
      grid-column: 1 / -1; 
    }
    
    label { 
      margin-bottom: 5px; 
      font-weight: 500; 
    }
    
    input, select, textarea { 
      padding: 10px; 
      border: 1px solid #ccc; 
      border-radius: 4px; 
      font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(217, 83, 79, 0.2);
    }
    
    .form-group.error input, .form-group.error select, .form-group.error textarea {
      border-color: var(--danger-red);
    }
    
    .error-message {
      color: var(--danger-red);
      font-size: 0.8rem;
      margin-top: 5px;
      display: none;
    }
    
    .form-group.error .error-message {
      display: block;
    }
    
    .form-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    
    .btn-submit {
      background-color: var(--secondary);
      color: var(--white);
    }
    
    .btn-submit:hover {
      background-color: #4cae4c;
    }
    
    .btn-delete {
      background-color: var(--primary);
      color: var(--white);
    }
    
    .btn-delete:hover {
      background-color: #c9302c;
    }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .toast {
      background: var(--white);
      border-radius: 4px;
      padding: 15px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      min-width: 300px;
      animation: slideInRight 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    
    .toast.hiding {
      animation: slideOutRight 0.3s forwards;
    }
    
    @keyframes slideOutRight {
      from { transform: translateX(0); }
      to { transform: translateX(100%); }
    }
    
    .toast-icon {
      margin-right: 10px;
      font-size: 1.2rem;
    }
    
    .toast.success {
      border-left: 4px solid var(--success-green);
    }
    
    .toast.success .toast-icon {
      color: var(--success-green);
    }
    
    .toast.error {
      border-left: 4px solid var(--danger-red);
    }
    
    .toast.error .toast-icon {
      color: var(--danger-red);
    }
    
    .toast.warning {
      border-left: 4px solid var(--warning);
    }
    
    .toast.warning .toast-icon {
      color: var(--warning);
    }
    
    .toast.info {
      border-left: 4px solid var(--info);
    }
    
    .toast.info .toast-icon {
      color: var(--info);
    }
    
    .toast-close {
      margin-left: auto;
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 1rem;
    }
    
    .toast-close:hover {
      color: var(--dark);
    }
    
    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: rgba(0,0,0,0.1);
      animation: progress 5s linear forwards;
    }
    
    @keyframes progress {
      from { width: 100%; }
      to { width: 0%; }
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Confirmation Dialog */
    .confirm-dialog {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2500;
    }
    
    .confirm-dialog.active {
      display: flex;
    }
    
    .confirm-container {
      background: var(--white);
      border-radius: 8px;
      padding: 20px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: slideIn 0.3s;
    }
    
    .confirm-title {
      margin-top: 0;
      color: var(--primary);
    }
    
    .confirm-message {
      margin-bottom: 20px;
    }
    
    .confirm-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* Keyboard Shortcuts Help */
    .shortcuts-help {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--white);
      border-radius: 8px;
      padding: 15px;
      box-shadow: var(--card-shadow);
      display: none;
      z-index: 1500;
      max-width: 300px;
    }
    
    .shortcuts-help.active {
      display: block;
    }
    
    .shortcuts-title {
      margin-top: 0;
      color: var(--primary);
      font-size: 1rem;
    }
    
    .shortcut-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    .shortcut-key {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
    
    /* Map Styles */
    .map-container {
      height: 400px;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
      box-shadow: var(--card-shadow);
    }
    
    #map { 
      height: 100%; 
      width: 100%; 
    }
    
    /* Monthly Sales Table Styles */
    .monthly-sales-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .monthly-sales-card {
      background: var(--white);
      border-radius: 8px;
      padding: 15px;
      box-shadow: var(--card-shadow);
      text-align: center;
    }
    
    .monthly-sales-card .month {
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--dark);
    }
    
    .monthly-sales-card .percentage {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 5px 0;
    }
    
    .monthly-sales-card .delivery-count {
      font-size: 0.9rem;
      color: #666;
    }
    
    .percentage-high {
      color: var(--success-green);
    }
    
    .percentage-medium {
      color: var(--warning);
    }
    
    .percentage-low {
      color: var(--danger-red);
    }
    
    /* Driver Details Card */
    .driver-details-card {
      background: var(--white);
      border-radius: 8px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      margin-bottom: 20px;
    }
    
    .driver-details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    
    .driver-details-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
      margin: 0;
    }
    
    .driver-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .driver-details-item {
      display: flex;
      flex-direction: column;
    }
    
    .driver-details-label {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 3px;
    }
    
    .driver-details-value {
      font-weight: 500;
    }
    
    /* Agent Performance Card */
    .agent-performance-card {
      background: var(--white);
      border-radius: 8px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      margin-bottom: 20px;
    }
    
    .agent-performance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    
    .agent-performance-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
      margin: 0;
    }
    
    .agent-performance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .agent-performance-item {
      display: flex;
      flex-direction: column;
      text-align: center;
    }
    
    .agent-performance-label {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 3px;
    }
    
    .agent-performance-value {
      font-size: 1.2rem;
      font-weight: 700;
    }
    
    .agent-performance-value.high {
      color: var(--success-green);
    }
    
    .agent-performance-value.medium {
      color: var(--warning);
    }
    
    .agent-performance-value.low {
      color: var(--danger-red);
    }
    
    /* Timestamp */
    .timestamp {
      font-size: 0.8rem;
      color: #666;
      margin-top: 5px;
    }
    
    /* Tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.8rem;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    /* Responsive */
    @media (max-width: 992px) {
      .container {
        flex-direction: column;
      }
      
      .nav-sidebar {
        width: 100%;
        height: auto;
      }
      
      .nav-menu {
        display: flex;
        flex-wrap: wrap;
      }
      
      .nav-item {
        margin-right: 5px;
        margin-bottom: 5px;
      }
      
      .nav-link {
        padding: 8px 15px;
        border-radius: 4px;
      }
      
      .section-controls {
        flex-direction: column;
        gap: 10px;
      }
      
      .search-box {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Navigation Sidebar -->
  <div class="nav-sidebar">
    <div class="nav-header">
      <h1><i class="fas fa-drumstick-bite"></i> Crispy Chicken</h1>
    </div>
    <ul class="nav-menu">
      <li class="nav-item">
        <a href="#" class="nav-link active" data-section="dashboard">
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-section="branches">
          <i class="fas fa-store"></i> Branches
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-section="drivers">
          <i class="fas fa-motorcycle"></i> Drivers
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-section="managers">
          <i class="fas fa-user-tie"></i> Managers
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-section="agents">
          <i class="fas fa-user-secret"></i> Agents
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-section="sales">
          <i class="fas fa-chart-line"></i> Sales
        </a>
      </li>
    </ul>
  </div>

  <!-- Main Content Area -->
  <div class="main-container">
    <!-- Dashboard Section -->
    <div id="dashboard-section" class="data-section active">
      <div class="content-header">
        <h2 class="content-title">Management Dashboard</h2>
        <div class="content-actions">
          <button class="btn btn-warning" onclick="resetData()">
            <i class="fas fa-undo"></i> Reset Data
          </button>
          <button class="btn btn-info" onclick="exportAllData()">
            <i class="fas fa-download"></i> Export All Data
          </button>
        </div>
      </div>
      <div class="content-body">
        <div class="dashboard-grid">
          <div class="dashboard-card branches">
            <div class="icon"><i class="fas fa-store"></i></div>
            <div class="content">
              <p class="value" id="total-branches">8</p>
              <p class="label">Total Branches</p>
              <div class="timestamp" id="branches-timestamp">Last updated: Never</div>
            </div>
          </div>
          
          <div class="dashboard-card drivers">
            <div class="icon"><i class="fas fa-motorcycle"></i></div>
            <div class="content">
              <p class="value" id="total-drivers">19</p>
              <p class="label">Total Drivers</p>
              <div class="timestamp" id="drivers-timestamp">Last updated: Never</div>
            </div>
          </div>
          
          <div class="dashboard-card managers">
            <div class="icon"><i class="fas fa-user-tie"></i></div>
            <div class="content">
              <p class="value" id="total-managers">8</p>
              <p class="label">Total Managers</p>
              <div class="timestamp" id="managers-timestamp">Last updated: Never</div>
            </div>
          </div>
          
          <div class="dashboard-card agents">
            <div class="icon"><i class="fas fa-user-secret"></i></div>
            <div class="content">
              <p class="value" id="total-agents">7</p>
              <p class="label">Total Agents</p>
              <div class="timestamp" id="agents-timestamp">Last updated: Never</div>
            </div>
          </div>
          
          <div class="dashboard-card sales">
            <div class="icon"><i class="fas fa-chart-line"></i></div>
            <div class="content">
              <p class="value" id="total-sales">AED 125,430</p>
              <p class="label">Total Sales</p>
              <div class="timestamp" id="sales-timestamp">Last updated: Never</div>
            </div>
          </div>
        </div>
        
        <div class="map-container">
          <div id="map"></div>
        </div>
        
        <div class="dashboard-grid">
          <div class="dashboard-card">
            <div class="icon"><i class="fas fa-check-circle" style="color: var(--success-green);"></i></div>
            <div class="content">
              <p class="value" id="active-branches">7</p>
              <p class="label">Active Branches</p>
            </div>
          </div>
          
          <div class="dashboard-card">
            <div class="icon"><i class="fas fa-bicycle" style="color: var(--info);"></i></div>
            <div class="content">
              <p class="value" id="total-bikes">18</p>
              <p class="label">Total Bikes</p>
            </div>
          </div>
          
          <div class="dashboard-card">
            <div class="icon"><i class="fas fa-users" style="color: var(--warning);"></i></div>
            <div class="content">
              <p class="value" id="total-staff">53</p>
              <p class="label">Total Staff</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Branches Section -->
    <div id="branches-section" class="data-section">
      <div class="content-header">
        <h2 class="content-title">Branch Management</h2>
        <div class="content-actions">
          <button class="btn btn-primary" onclick="openBranchForm()">
            <i class="fas fa-plus"></i> Add Branch
          </button>
          <button class="btn btn-info" onclick="exportData('branches')">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
      </div>
      <div class="content-body">
        <div class="section-controls">
          <input type="text" class="search-box" id="branch-search" placeholder="Search branches...">
        </div>
        <div class="data-table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Branch Name</th>
                <th>City</th>
                <th>Area</th>
                <th>Manager</th>
                <th>Delivery Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="branch-table-body">
              <!-- Branch data will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Drivers Section -->
    <div id="drivers-section" class="data-section">
      <div class="content-header">
        <h2 class="content-title">Driver Management</h2>
        <div class="content-actions">
          <button class="btn btn-primary" onclick="openDriverForm()">
            <i class="fas fa-plus"></i> Add Driver
          </button>
          <button class="btn btn-info" onclick="exportData('drivers')">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
      </div>
      <div class="content-body">
        <div class="section-controls">
          <input type="text" class="search-box" id="driver-search" placeholder="Search drivers...">
        </div>
        
        <!-- Driver Details Summary Card -->
        <div class="driver-details-card">
          <div class="driver-details-header">
            <h3 class="driver-details-title">Driver Statistics</h3>
          </div>
          <div class="driver-details-grid">
            <div class="driver-details-item">
              <span class="driver-details-label">Total Drivers</span>
              <span class="driver-details-value" id="driver-total-count">19</span>
            </div>
            <div class="driver-details-item">
              <span class="driver-details-label">Active Drivers</span>
              <span class="driver-details-value" id="driver-active-count">15</span>
            </div>
            <div class="driver-details-item">
              <span class="driver-details-label">Inactive Drivers</span>
              <span class="driver-details-value" id="driver-inactive-count">4</span>
            </div>
            <div class="driver-details-item">
              <span class="driver-details-label">Expired Licenses</span>
              <span class="driver-details-value" id="driver-expired-count">2</span>
            </div>
          </div>
        </div>
        
        <div class="data-table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Driver Name</th>
                <th>Mobile Number</th>
                <th>Bike Number</th>
                <th>Outlet</th>
                <th>Plate Number</th>
                <th>License Expiry</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="driver-table-body">
              <!-- Driver data will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Managers Section -->
    <div id="managers-section" class="data-section">
      <div class="content-header">
        <h2 class="content-title">Manager Management</h2>
        <div class="content-actions">
          <button class="btn btn-primary" onclick="openManagerForm()">
            <i class="fas fa-plus"></i> Add Manager
          </button>
          <button class="btn btn-info" onclick="exportData('managers')">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
      </div>
      <div class="content-body">
        <div class="section-controls">
          <input type="text" class="search-box" id="manager-search" placeholder="Search managers...">
        </div>
        <div class="data-table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Branch</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="manager-table-body">
              <!-- Manager data will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Agents Section -->
    <div id="agents-section" class="data-section">
      <div class="content-header">
        <h2 class="content-title">Agent Management</h2>
        <div class="content-actions">
          <button class="btn btn-primary" onclick="openAgentForm()">
            <i class="fas fa-plus"></i> Add Agent
          </button>
          <button class="btn btn-info" onclick="exportData('agents')">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
      </div>
      <div class="content-body">
        <div class="section-controls">
          <input type="text" class="search-box" id="agent-search" placeholder="Search agents...">
          <select id="month-filter" class="search-box" style="width: 200px;">
            <option value="">All Months</option>
            <option value="January">January</option>
            <option value="February">February</option>
            <option value="March">March</option>
            <option value="April">April</option>
            <option value="May">May</option>
            <option value="June">June</option>
            <option value="July">July</option>
            <option value="August">August</option>
            <option value="September">September</option>
            <option value="October">October</option>
            <option value="November">November</option>
            <option value="December">December</option>
          </select>
        </div>
        
        <!-- Agent Performance Summary Card -->
        <div class="agent-performance-card">
          <div class="agent-performance-header">
            <h3 class="agent-performance-title">Agent Performance Summary</h3>
            <span id="agent-summary-period" style="color: #666; font-size: 0.9rem;">All Months</span>
          </div>
          <div class="agent-performance-grid">
            <div class="agent-performance-item">
              <span class="agent-performance-label">Total Rings</span>
              <span class="agent-performance-value" id="agent-total-rings">22,695</span>
            </div>
            <div class="agent-performance-item">
              <span class="agent-performance-label">Answered</span>
              <span class="agent-performance-value" id="agent-answered">11,574</span>
            </div>
            <div class="agent-performance-item">
              <span class="agent-performance-label">Missed</span>
              <span class="agent-performance-value" id="agent-missed">11,121</span>
            </div>
            <div class="agent-performance-item">
              <span class="agent-performance-label">Missed Rate</span>
              <span class="agent-performance-value medium" id="agent-missed-rate">49.0%</span>
            </div>
            <div class="agent-performance-item">
              <span class="agent-performance-label">Avg. Wait Time</span>
              <span class="agent-performance-value" id="agent-avg-wait">00:00:14</span>
            </div>
            <div class="agent-performance-item">
              <span class="agent-performance-label">Max Wait Time</span>
              <span class="agent-performance-value" id="agent-max-wait">00:04:55</span>
            </div>
            <div class="agent-performance-item">
              <span class="agent-performance-label">Avg. Talk Time</span>
              <span class="agent-performance-value" id="agent-avg-talk">00:01:46</span>
            </div>
            <div class="agent-performance-item">
              <span class="agent-performance-label">Total Talk Time</span>
              <span class="agent-performance-value" id="agent-total-talk">377:27:34</span>
            </div>
          </div>
        </div>
        
        <div class="data-table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Agent Name</th>
                <th>Month</th>
                <th>Total Rings</th>
                <th>Answered</th>
                <th>Missed</th>
                <th>Avg. Wait Time</th>
                <th>Max Wait Time</th>
                <th>Avg. Talk Time</th>
                <th>Total Talk Time</th>
                <th>Missed Rate</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="agent-table-body">
              <!-- Agent data will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Sales Section -->
    <div id="sales-section" class="data-section">
      <div class="content-header">
        <h2 class="content-title">Sales Management</h2>
        <div class="content-actions">
          <button class="btn btn-primary" onclick="openMonthlySalesForm()">
            <i class="fas fa-plus"></i> Add Monthly Sales
          </button>
          <button class="btn btn-info" onclick="exportData('monthly-sales')">
            <i class="fas fa-download"></i> Export
          </button>
        </div>
      </div>
      <div class="content-body">
        <div class="section-controls">
          <input type="text" class="search-box" id="monthly-sales-search" placeholder="Search monthly sales...">
          <select id="year-filter" class="search-box" style="width: 200px;">
            <option value="">All Years</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
          </select>
          <select id="sales-month-filter" class="search-box" style="width: 200px;">
            <option value="">All Months</option>
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
        
        <!-- Monthly Sales Summary Cards -->
        <div class="monthly-sales-grid" id="monthly-sales-summary">
          <!-- Monthly sales summary cards will be inserted here -->
        </div>
        
        <div class="data-table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Branch</th>
                <th>Year</th>
                <th>Month</th>
                <th>Delivery Count</th>
                <th>Percentage</th>
                <th>Sales Amount</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="monthly-sales-table-body">
              <!-- Monthly sales data will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Branch Form Popup -->
<div id="branch-form-popup" class="form-popup">
  <div class="form-container">
    <span class="close-btn" onclick="confirmCloseForm('branch-form-popup')">&times;</span>
    <h2 class="form-title" id="branch-form-title">Add New Branch</h2>
    <form id="branch-form">
      <input type="hidden" id="branch-edit-id">
      <div class="form-group"><label for="branch-name">Branch Name</label><input type="text" id="branch-name" required><span class="error-message">Branch name is required</span></div>
      <div class="form-group"><label for="branch-city">City</label><input type="text" id="branch-city" required><span class="error-message">City is required</span></div>
      <div class="form-group"><label for="branch-direction">Coordinates (lat, lng)</label><input type="text" id="branch-direction" placeholder="24.4958, 54.3715"></div>
      <div class="form-group"><label for="branch-area">Area</label><input type="text" id="branch-area"></div>
      <div class="form-group"><label for="branch-landline">Landline</label><input type="text" id="branch-landline"></div>
      <div class="form-group"><label for="branch-google-site">Google Site</label><input type="url" id="branch-google-site"></div>
      <div class="form-group"><label for="branch-rate">Rate</label><input type="number" id="branch-rate" step="0.1"></div>
      <div class="form-group"><label for="branch-manager">Manager</label><select id="branch-manager"></select></div>
      <div class="form-group"><label for="branch-email">Email</label><input type="email" id="branch-email"></div>
      <div class="form-group"><label for="branch-delivery-status">Delivery Status</label><select id="branch-delivery-status"><option>Yes</option><option>No</option><option>N/A</option></select></div>
      <div class="form-group"><label for="branch-link-online">Online Link</label><input type="url" id="branch-link-online"></div>
      <div class="form-group"><label for="branch-num-bikes">Number Bikes</label><input type="number" id="branch-num-bikes"></div>
      <div class="form-group"><label for="branch-num-drivers">Number Drivers</label><input type="number" id="branch-num-drivers"></div>
      
      <!-- Device Fields -->
      <div class="form-group"><label for="branch-talabat-device">Talabat Device</label><select id="branch-talabat-device"><option value="1">Yes</option><option value="0">No</option></select></div>
      <div class="form-group"><label for="branch-noon-device">Noon Device</label><select id="branch-noon-device"><option value="1">Yes</option><option value="0">No</option></select></div>
      <div class="form-group"><label for="branch-careem-device">Careem Device</label><select id="branch-careem-device"><option value="1">Yes</option><option value="0">No</option></select></div>
      <div class="form-group"><label for="branch-deliveroo-device">Deliveroo Device</label><select id="branch-deliveroo-device"><option value="1">Yes</option><option value="0">No</option></select></div>
      <div class="form-group"><label for="branch-smile-device">Smile Device</label><select id="branch-smile-device"><option value="1">Yes</option><option value="0">No</option></select></div>
      <div class="form-group"><label for="branch-talabana-device">Talabana Device</label><select id="branch-talabana-device"><option value="1">Yes</option><option value="0">No</option></select></div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="clearForm('branch-form')">
          <i class="fas fa-eraser"></i> Clear All
        </button>
        <div>
          <button type="submit" class="btn btn-submit" id="branch-submit-btn">Save Branch</button>
          <button type="button" class="btn btn-delete" id="branch-delete-btn" style="display:none;">Delete Branch</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Driver Form Popup -->
<div id="driver-form-popup" class="form-popup">
  <div class="form-container">
    <span class="close-btn" onclick="confirmCloseForm('driver-form-popup')">&times;</span>
    <h2 class="form-title" id="driver-form-title">Add New Driver</h2>
    <form id="driver-form">
      <input type="hidden" id="driver-edit-id">
      <div class="form-group"><label for="driver-name">Driver Name</label><input type="text" id="driver-name" required><span class="error-message">Driver name is required</span></div>
      <div class="form-group"><label for="driver-mobile">Mobile Number</label><input type="text" id="driver-mobile" required><span class="error-message">Mobile number is required</span></div>
      <div class="form-group"><label for="driver-bike-number">Bike Number</label><input type="text" id="driver-bike-number"></div>
      <div class="form-group"><label for="driver-outlet">Outlet</label><select id="driver-outlet"></select></div>
      <div class="form-group"><label for="driver-plate-number">Plate Number</label><input type="text" id="driver-plate-number"></div>
      <div class="form-group"><label for="driver-license-expiry">License Expiry</label><input type="date" id="driver-license-expiry" required><span class="error-message">License expiry is required</span></div>
      <div class="form-group"><label for="driver-traffic-code">Traffic Code</label><input type="text" id="driver-traffic-code"></div>
      <div class="form-group"><label for="driver-document-number">Document Number</label><input type="text" id="driver-document-number"></div>
      <div class="form-group"><label for="driver-ownership-expiry">Ownership Expiry</label><input type="date" id="driver-ownership-expiry"></div>
      <div class="form-group"><label for="driver-driving-license">Driving License No.</label><input type="text" id="driver-driving-license"></div>
      <div class="form-group"><label for="driver-driving-license-expiry">Driving License Expiry</label><input type="date" id="driver-driving-license-expiry"></div>
      <div class="form-group"><label for="driver-join-date">Join Date</label><input type="date" id="driver-join-date"></div>
      <div class="form-group"><label for="driver-salary">Salary</label><input type="number" id="driver-salary"></div>
      <div class="form-group"><label for="driver-status">Status</label><select id="driver-status"><option>Active</option><option>Inactive</option><option>On Leave</option></select></div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="clearForm('driver-form')">
          <i class="fas fa-eraser"></i> Clear All
        </button>
        <div>
          <button type="submit" class="btn btn-submit" id="driver-submit-btn">Save Driver</button>
          <button type="button" class="btn btn-delete" id="driver-delete-btn" style="display:none;">Delete Driver</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Manager Form Popup -->
<div id="manager-form-popup" class="form-popup">
  <div class="form-container">
    <span class="close-btn" onclick="confirmCloseForm('manager-form-popup')">&times;</span>
    <h2 class="form-title" id="manager-form-title">Add New Manager</h2>
    <form id="manager-form">
      <input type="hidden" id="manager-edit-id">
      <div class="form-group"><label for="manager-name">Name</label><input type="text" id="manager-name" required><span class="error-message">Name is required</span></div>
      <div class="form-group"><label for="manager-phone">Phone</label><input type="text" id="manager-phone" required><span class="error-message">Phone is required</span></div>
      <div class="form-group"><label for="manager-email">Email</label><input type="email" id="manager-email"></div>
      <div class="form-group"><label for="manager-branch">Branch</label><select id="manager-branch"></select></div>
      <div class="form-group"><label for="manager-join-date">Join Date</label><input type="date" id="manager-join-date"></div>
      <div class="form-group"><label for="manager-salary">Salary</label><input type="number" id="manager-salary"></div>
      <div class="form-group"><label for="manager-status">Status</label><select id="manager-status"><option>Active</option><option>Inactive</option><option>On Leave</option></select></div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="clearForm('manager-form')">
          <i class="fas fa-eraser"></i> Clear All
        </button>
        <div>
          <button type="submit" class="btn btn-submit" id="manager-submit-btn">Save Manager</button>
          <button type="button" class="btn btn-delete" id="manager-delete-btn" style="display:none;">Delete Manager</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Agent Form Popup -->
<div id="agent-form-popup" class="form-popup">
  <div class="form-container">
    <span class="close-btn" onclick="confirmCloseForm('agent-form-popup')">&times;</span>
    <h2 class="form-title" id="agent-form-title">Add New Agent</h2>
    <form id="agent-form">
      <input type="hidden" id="agent-edit-id">
      <div class="form-group"><label for="agent-name">Agent Name</label><input type="text" id="agent-name" required><span class="error-message">Agent name is required</span></div>
      <div class="form-group"><label for="agent-phone">Phone</label><input type="text" id="agent-phone" required><span class="error-message">Phone is required</span></div>
      <div class="form-group"><label for="agent-email">Email</label><input type="email" id="agent-email"></div>
      <div class="form-group"><label for="agent-area">Area</label><input type="text" id="agent-area"></div>
      <div class="form-group"><label for="agent-commission">Commission (%)</label><input type="number" id="agent-commission" min="0" max="100" step="0.1"></div>
      <div class="form-group"><label for="agent-join-date">Join Date</label><input type="date" id="agent-join-date"></div>
      <div class="form-group"><label for="agent-status">Status</label><select id="agent-status"><option>Active</option><option>Inactive</option></select></div>
      
      <!-- Performance Metrics Fields -->
      <div class="form-group"><label for="agent-month">Month</label><select id="agent-month"><option value="">Select Month</option><option value="January">January</option><option value="February">February</option><option value="March">March</option><option value="April">April</option><option value="May">May</option><option value="June">June</option><option value="July">July</option><option value="August">August</option><option value="September">September</option><option value="October">October</option><option value="November">November</option><option value="December">December</option></select></div>
      <div class="form-group"><label for="agent-total-rings">Total Rings</label><input type="number" id="agent-total-rings" min="0"></div>
      <div class="form-group"><label for="agent-answered">Answered</label><input type="number" id="agent-answered" min="0"></div>
      <div class="form-group"><label for="agent-missed">Missed</label><input type="number" id="agent-missed" min="0"></div>
      <div class="form-group"><label for="agent-avg-wait-time">Average Waiting Time</label><input type="text" id="agent-avg-wait-time" placeholder="HH:MM:SS"></div>
      <div class="form-group"><label for="agent-max-wait-time">Max Waiting Time</label><input type="text" id="agent-max-wait-time" placeholder="HH:MM:SS"></div>
      <div class="form-group"><label for="agent-avg-talk-time">Average Talking Time</label><input type="text" id="agent-avg-talk-time" placeholder="HH:MM:SS"></div>
      <div class="form-group"><label for="agent-total-talk-time">Total Talking Time</label><input type="text" id="agent-total-talk-time" placeholder="HH:MM:SS"></div>
      <div class="form-group"><label for="agent-missed-rate">Missed Rate (%)</label><input type="number" id="agent-missed-rate" min="0" max="100" step="0.01"></div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="clearForm('agent-form')">
          <i class="fas fa-eraser"></i> Clear All
        </button>
        <div>
          <button type="submit" class="btn btn-submit" id="agent-submit-btn">Save Agent</button>
          <button type="button" class="btn btn-delete" id="agent-delete-btn" style="display:none;">Delete Agent</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Monthly Sales Form Popup -->
<div id="monthly-sales-form-popup" class="form-popup">
  <div class="form-container">
    <span class="close-btn" onclick="confirmCloseForm('monthly-sales-form-popup')">&times;</span>
    <h2 class="form-title" id="monthly-sales-form-title">Add Monthly Sales</h2>
    <form id="monthly-sales-form">
      <input type="hidden" id="monthly-sales-edit-id">
      <div class="form-group"><label for="monthly-sales-branch">Branch</label><select id="monthly-sales-branch" required></select><span class="error-message">Branch is required</span></div>
      <div class="form-group"><label for="monthly-sales-year">Year</label><select id="monthly-sales-year" required></select><span class="error-message">Year is required</span></div>
      <div class="form-group"><label for="monthly-sales-month">Month</label><select id="monthly-sales-month" required></select><span class="error-message">Month is required</span></div>
      <div class="form-group"><label for="monthly-sales-delivery-count">Delivery Count</label><input type="number" id="monthly-sales-delivery-count" min="0" required><span class="error-message">Delivery count is required</span></div>
      <div class="form-group"><label for="monthly-sales-percentage">Percentage (%)</label><input type="number" id="monthly-sales-percentage" min="0" max="100" step="0.1" required><span class="error-message">Percentage is required</span></div>
      <div class="form-group"><label for="monthly-sales-amount">Sales Amount (AED)</label><input type="number" id="monthly-sales-amount" min="0" step="0.01" required><span class="error-message">Sales amount is required</span></div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="clearForm('monthly-sales-form')">
          <i class="fas fa-eraser"></i> Clear All
        </button>
        <div>
          <button type="submit" class="btn btn-submit" id="monthly-sales-submit-btn">Save Monthly Sales</button>
          <button type="button" class="btn btn-delete" id="monthly-sales-delete-btn" style="display:none;">Delete Monthly Sales</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Confirmation Dialog -->
<div id="confirm-dialog" class="confirm-dialog">
  <div class="confirm-container">
    <h3 class="confirm-title" id="confirm-title">Confirm Action</h3>
    <p class="confirm-message" id="confirm-message">Are you sure you want to proceed?</p>
    <div class="confirm-actions">
      <button class="btn btn-secondary" id="confirm-cancel">Cancel</button>
      <button class="btn btn-primary" id="confirm-ok">Confirm</button>
    </div>
  </div>
</div>

<!-- Keyboard Shortcuts Help -->
<div id="shortcuts-help" class="shortcuts-help">
  <h3 class="shortcuts-title">Keyboard Shortcuts</h3>
  <div class="shortcut-item">
    <span>Save Form</span>
    <span class="shortcut-key">Ctrl+S</span>
  </div>
  <div class="shortcut-item">
    <span>Close Form</span>
    <span class="shortcut-key">Esc</span>
  </div>
  <div class="shortcut-item">
    <span>Export Data</span>
    <span class="shortcut-key">Ctrl+E</span>
  </div>
  <div class="shortcut-item">
    <span>Help</span>
    <span class="shortcut-key">Ctrl+?</span>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
  <div class="loading-spinner"></div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container"></div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // --- GLOBAL STATE ---
  let map;
  let branchMarkers = [];
  let activeSection = 'dashboard';
  let salesChart = null;
  let formHasChanges = {};
  let confirmCallback = null;
  
  // --- DATA PERSISTENCE ---
  const STORAGE_KEY = 'crispy_chicken_data';
  const TIMESTAMP_KEY = 'crispy_chicken_timestamps';
  
  // Sample data
  const defaultSampleData = {
    branches: [
      {
        ID: 1,
        'Branch Name': 'Crispy Chicken-Hamdan St',
        City: 'Abu Dhabi',
        direction: '24.4958298421285, 54.37155779999593',
        AREA: 'Hamdan Opposite Sun and San Sports',
        'Land line': '(02) 641 1194',
        'Google site': 'https://g.co/kgs/TrxJBJV',
        RATE: '4',
        'Manger name': 'Mr. Mahmoud',
        'Number manager': '971 55 688 6650',
        'Email address': 'crispychickenhamdan@gmail.com',
        'Delivery status': 'Yes',
        'Link online': 'http://almarkaziya.crispychicken-uae.com/#_branch94929',
        'Number bikes': '7',
        'Number driver': '7',
        'Talabat device': '1',
        'Noon device': '1',
        'Careen device': '1',
        'Deliveroo device': '1',
        'Smile device': '1',
        'Talabana device': '1'
      },
      {
        ID: 2,
        'Branch Name': 'Crispy chicken Shabiya 11',
        City: 'Abu Dhabi',
        direction: '24.328366371847554, 54.535004577124376',
        AREA: 'Mohamed Bin Zayed City - ME-11',
        'Land line': '(02) 554 9889',
        'Google site': 'https://g.co/kgs/QQh8CXL',
        RATE: '3.7',
        'Manger name': 'Mr. Zakaria',
        'Number manager': '971 56 269 0688',
        'Email address': 'shabiha@crispychicken.rest',
        'Delivery status': 'Yes',
        'Link online': 'http://crispychicken-uae.com/#_branch94472',
        'Number bikes': '',
        'Number driver': '4',
        'Talabat device': '1',
        'Noon device': '1',
        'Careen device': '1',
        'Deliveroo device': '1',
        'Smile device': '1',
        'Talabana device': '1'
      },
      {
        ID: 3,
        'Branch Name': 'Crispy chicken khaldia',
        City: 'Abu Dhabi',
        direction: '24.47955696172264, 54.353930808868604',
        AREA: 'Khalidiya Tower - Al Khalidiya Street - opp. Grand Store',
        'Land line': '(02) 546 0900',
        'Google site': 'https://g.co/kgs/Du9UqrY',
        RATE: '3.9',
        'Manger name': 'Mr. Adel',
        'Number manager': '971 56 949 4764',
        'Email address': 'crispychicken.khalidia@gmail.com',
        'Delivery status': 'Yes',
        'Link online': 'http://alkhalidiyah.crispychicken-uae.com/#_branch94938',
        'Number bikes': '',
        'Number driver': '4',
        'Talabat device': '1',
        'Noon device': '1',
        'Careen device': '1',
        'Deliveroo device': '1',
        'Smile device': '1',
        'Talabana device': '1'
      },
      {
        ID: 4,
        'Branch Name': 'Crispy chicken Elactra',
        City: 'Abu Dhabi',
        direction: '',
        AREA: 'Electra street opp LLH hospital',
        'Land line': '(02)8826902',
        'Google site': '',
        RATE: '',
        'Manger name': 'Mr. RJ',
        'Number manager': '971 56 386 6859',
        'Email address': 'electra@crispychicken.rest',
        'Delivery status': 'N/A',
        'Link online': 'N/A',
        'Number bikes': '0',
        'Number driver': '0',
        'Talabat device': '1',
        'Noon device': '1',
        'Careen device': '1',
        'Deliveroo device': '',
        'Smile device': '1',
        'Talabana device': ''
      },
      {
        ID: 5,
        'Branch Name': 'Crispy chicken Muroor',
        City: 'Abu Dhabi',
        direction: '24.434503442604896, 54.43866580679551',
        AREA: '31 Muroor Rd - Al Sa\'adah - Zone 1',
        'Land line': '(02) 563 3359',
        'Google site': 'https://g.co/kgs/qS1e4Bi',
        RATE: '4',
        'Manger name': 'Mr. Tariq',
        'Number manager': '971 50 541 4641',
        'Email address': 'MOUROOR@CRISPYCHICKEN.REST',
        'Delivery status': 'Yes',
        'Link online': 'http://almuroorroad.crispychicken-uae.com/#_branch102831',
        'Number bikes': '',
        'Number driver': '3',
        'Talabat device': '1',
        'Noon device': '1',
        'Careen device': '1',
        'Deliveroo device': '1',
        'Smile device': '1',
        'Talabana device': '1'
      },
      {
        ID: 6,
        'Branch Name': 'Crispy chicken Al Barsha',
        City: 'Dubai',
        direction: '25.11589564435004, 55.20455565397946',
        AREA: 'Al Barsha 1',
        'Land line': '(04) 835 8195',
        'Google site': 'https://g.co/kgs/6xh7DNw',
        RATE: '4.4',
        'Manger name': 'Mr. Mahmed',
        'Number manager': '971569659524',
        'Email address': 'barsha@crispychicken.rest',
        'Delivery status': 'Yes',
        'Link online': 'http://albarsha.crispychicken-uae.com/#_branch124062',
        'Number bikes': '',
        'Number driver': '4',
        'Talabat device': '1',
        'Noon device': '1',
        'Careen device': '1',
        'Deliveroo device': '1',
        'Smile device': '1',
        'Talabana device': '1'
      },
      {
        ID: 7,
        'Branch Name': 'Crispy chicken Al Satwa',
        City: 'Dubai',
        direction: '25.232522002773372, 55.2694237276173',
        AREA: 'Satwa street Dubai',
        'Land line': '(04)3265878',
        'Google site': 'https://maps.app.goo.gl/XnyngSy4wgtSLRfc8',
        RATE: '4.5',
        'Manger name': 'Mr. Musab',
        'Number manager': '971 56 797 0685',
        'Email address': 'satwa@crispychicken.rest',
        'Delivery status': 'Yes',
        'Link online': 'http://satwa.crispychicken-uae.com/#_branch173500',
        'Number bikes': '',
        'Number driver': '3',
        'Talabat device': '1',
        'Noon device': '1',
        'Careen device': '1',
        'Deliveroo device': '1',
        'Smile device': '1',
        'Talabana device': '1'
      },
      {
        ID: 8,
        'Branch Name': 'Crispy chicken Al Regga',
        City: 'Dubai',
        direction: 'new brunch',
        AREA: 'AReega area',
        'Land line': '',
        'Google site': 'https://maps.app.goo.gl/rfpWM5nrFTkxZMiX6?g_st=iw',
        RATE: '5',
        'Manger name': 'Mr. Zaid',
        'Number manager': '971 56 740 5572',
        'Email address': '',
        'Delivery status': 'Yes',
        'Link online': '',
        'Number bikes': '',
        'Number driver': '',
        'Talabat device': '',
        'Noon device': '',
        'Careem device': '',
        'Deliveroo device': '',
        'Smile device': '',
        'Talabana device': ''
      }
    ],
    drivers: [
      { ID: 1, Name: 'SHIV SHANKAR YADAV', MobileNumber: '503170735', BikeNumber: '77928', Outlet: '—', PlateNumber: '77928', LicenseExpiry: '01/04/2024', TrafficCode: '11700009007', DocumentNumber: '2210097466', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2022-01-15', Salary: 3500, Status: 'Active' },
      { ID: 2, Name: 'RAM KUMAR LINGTHEP', MobileNumber: '557462966', BikeNumber: '89974', Outlet: '—', PlateNumber: '89974', LicenseExpiry: '19/11/2023', TrafficCode: '1170009007', DocumentNumber: '2223252387', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2021-05-20', Salary: 3200, Status: 'Active' },
      { ID: 3, Name: 'SUBASH', MobileNumber: '565843840', BikeNumber: '86342', Outlet: '—', PlateNumber: '86342', LicenseExpiry: '11/11/2023', TrafficCode: '1170009007', DocumentNumber: '2223290675', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2022-03-10', Salary: 3400, Status: 'Active' },
      { ID: 4, Name: 'NUR', MobileNumber: '526131479', BikeNumber: '89973', Outlet: '—', PlateNumber: '89973', LicenseExpiry: '19/10/2023', TrafficCode: '1170009007', DocumentNumber: '2223252351', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2021-11-05', Salary: 3000, Status: 'Inactive' },
      { ID: 5, Name: 'SAROJ', MobileNumber: '501256103', BikeNumber: '90839', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2022-02-28', Salary: 3300, Status: 'Active' },
      { ID: 6, Name: 'KHADAER', MobileNumber: '501503367', BikeNumber: '76640', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2021-09-12', Salary: 3600, Status: 'Active' },
      { ID: 7, Name: 'ABUBAKER', MobileNumber: '553352894', BikeNumber: '69102', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2021-04-22', Salary: 3500, Status: 'Active' },
      { ID: 8, Name: 'THAMBI', MobileNumber: '542678422', BikeNumber: '69098', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2022-06-01', Salary: 3400, Status: 'On Leave' },
      { ID: 9, Name: 'IRFAN', MobileNumber: '564746848', BikeNumber: '91709', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2022-01-10', Salary: 3500, Status: 'Active' },
      { ID: 10, Name: 'SHAHEER', MobileNumber: '508648469', BikeNumber: '76639', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2020-03-15', Salary: 11000, Status: 'Active' },
      { ID: 11, Name: 'MOSHIN', MobileNumber: '507598095', BikeNumber: '91710', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2020-08-15', Salary: 11000, Status: 'Active' },
      { ID: 12, Name: 'MOHAMMED', MobileNumber: '526131479', BikeNumber: '89973', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2020-11-20', Salary: 11500, Status: 'Active' },
      { ID: 13, Name: 'AJIJU', MobileNumber: '566011935', BikeNumber: '76614', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2021-02-05', Salary: 10000, Status: 'Inactive' },
      { ID: 14, Name: 'SHARBAK', MobileNumber: '564875258', BikeNumber: '89017', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2020-07-12', Salary: 11200, Status: 'Active' },
      { ID: 15, Name: 'RHAHAMAT', MobileNumber: '566361037', BikeNumber: '76642', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2019-09-18', Salary: 12500, Status: 'Active' },
      { ID: 16, Name: 'SHANKA', MobileNumber: '561486312', BikeNumber: '80949', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2021-04-22', Salary: 11800, Status: 'Active' },
      { ID: 17, Name: 'OMAR', MobileNumber: '507482124', BikeNumber: '85675', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2022-01-08', Salary: 11000, Status: 'Active' },
      { ID: 18, Name: 'KHALIL', MobileNumber: '505258629', BikeNumber: '80951', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2022-02-05', Salary: 11000, Status: 'Active' },
      { ID: 19, Name: 'ABDALKAREM', MobileNumber: '547265580', BikeNumber: '77698', Outlet: '—', PlateNumber: '—', LicenseExpiry: '—', TrafficCode: '—', DocumentNumber: '—', OwnershipExpiry: '—', DrivingLicenseNo: '—', DrivingLicenseExpiry: '—', JoinDate: '2022-03-10', Salary: 11000, Status: 'Active' }
    ],
    managers: [
      { ID: 1, Name: 'Mr. Mahmoud', Phone: '971 55 688 6650', Email: 'crispychickenhamdan@gmail.com', Branch: 'Crispy Chicken-Hamdan St', JoinDate: '2020-01-10', Salary: 12000, Status: 'Active' },
      { ID: 2, Name: 'Mr. Zakaria', Phone: '971 56 269 0688', Email: 'shabiha@crispychicken.rest', Branch: 'Crispy chicken Shabiya 11', JoinDate: '2020-03-15', Salary: 11000, Status: 'Active' },
      { ID: 3, Name: 'Mr. Adel', Phone: '971 56 949 4764', Email: 'crispychicken.khalidia@gmail.com', Branch: 'Crispy chicken khaldia', JoinDate: '2019-11-20', Salary: 11500, Status: 'Active' },
      { ID: 4, Name: 'Mr. RJ', Phone: '971 56 386 6859', Email: 'electra@crispychicken.rest', Branch: 'Crispy chicken Elactra', JoinDate: '2021-02-05', Salary: 10000, Status: 'Inactive' },
      { ID: 5, Name: 'Mr. Tariq', Phone: '971 50 541 4641', Email: 'MOUROOR@CRISPYCHICKEN.REST', Branch: 'Crispy chicken Muroor', JoinDate: '2020-07-12', Salary: 11200, Status: 'Active' },
      { ID: 6, Name: 'Mr. Mahmed', Phone: '971569659524', Email: 'barsha@crispychicken.rest', Branch: 'Crispy chicken Al Barsha', JoinDate: '2019-09-18', Salary: 12500, Status: 'Active' },
      { ID: 7, Name: 'Mr. Musab', Phone: '971 56 797 0685', Email: 'satwa@crispychicken.rest', Branch: 'Crispy chicken Al Satwa', JoinDate: '2021-04-22', Salary: 11800, Status: 'Active' },
      { ID: 8, Name: 'Mr. Zaid', Phone: '971 56 740 5572', Email: '', Branch: 'Crispy chicken Al Regga', JoinDate: '2022-01-08', Salary: 11000, Status: 'Active' }
    ],
    agents: [
      { ID: 201, Name: 'Ann Areille David', Phone: '971 50 111 2233', Email: 'ann@example.com', Area: 'Hamdan Street', Commission: 5, JoinDate: '2021-03-10', Status: 'Active', Month: 'October', TotalRings: 3560, Answered: 1606, Missed: 1954, AvgWaitTime: '00:00:17', MaxWaitTime: '00:04:22', AvgTalkTime: '00:01:43', TotalTalkTime: '46:13:04', MissedRate: 54.89 },
      { ID: 202, Name: 'SALEH EMAD 202', Phone: '971 55 222 3344', Email: 'saleh@example.com', Area: 'Khalidiya', Commission: 4.5, JoinDate: '2020-08-15', Status: 'Active', Month: 'October', TotalRings: 2853, Answered: 1422, Missed: 1431, AvgWaitTime: '00:00:14', MaxWaitTime: '00:04:36', AvgTalkTime: '00:01:49', TotalTalkTime: '43:08:30', MissedRate: 50.16 },
      { ID: 203, Name: 'Nona Rose', Phone: '971 56 333 4455', Email: 'nona@example.com', Area: 'Muroor Road', Commission: 6, JoinDate: '2021-11-20', Status: 'Active', Month: 'October', TotalRings: 4408, Answered: 2475, Missed: 1933, AvgWaitTime: '00:00:11', MaxWaitTime: '00:03:52', AvgTalkTime: '00:02:01', TotalTalkTime: '83:23:10', MissedRate: 43.85 },
      { ID: 204, Name: 'manju ranabhat', Phone: '971 54 444 5566', Email: 'manju@example.com', Area: 'Al Barsha', Commission: 5.5, JoinDate: '2022-02-05', Status: 'Active', Month: 'October', TotalRings: 5461, Answered: 2625, Missed: 2836, AvgWaitTime: '00:00:13', MaxWaitTime: '00:04:55', AvgTalkTime: '00:01:40', TotalTalkTime: '73:27:36', MissedRate: 51.93 },
      { ID: 205, Name: 'Melvin compendio', Phone: '971 52 555 6677', Email: 'melvin@example.com', Area: 'Al Satwa', Commission: 4, JoinDate: '2021-07-12', Status: 'Active', Month: 'October', TotalRings: 2062, Answered: 1082, Missed: 980, AvgWaitTime: '00:00:12', MaxWaitTime: '00:03:26', AvgTalkTime: '00:01:58', TotalTalkTime: '35:34:15', MissedRate: 47.53 },
      { ID: 206, Name: 'AGENT', Phone: '971 55 666 7788', Email: 'agent@example.com', Area: 'Al Reega', Commission: 7, JoinDate: '2022-05-18', Status: 'Active', Month: 'October', TotalRings: 2286, Answered: 1248, Missed: 1038, AvgWaitTime: '00:00:16', MaxWaitTime: '00:03:10', AvgTalkTime: '00:01:37', TotalTalkTime: '33:48:22', MissedRate: 45.41 },
      { ID: 207, Name: 'Asmita Sapkota', Phone: '971 50 777 8899', Email: 'asmita@example.com', Area: 'Hamdan Street', Commission: 5.5, JoinDate: '2021-09-18', Status: 'Active', Month: 'October', TotalRings: 4617, Answered: 2116, Missed: 2501, AvgWaitTime: '00:00:16', MaxWaitTime: '00:04:22', AvgTalkTime: '00:01:44', TotalTalkTime: '61:42:37', MissedRate: 54.17 },
      // November data
      { ID: 208, Name: 'Ann Areille David', Phone: '971 50 111 2233', Email: 'ann@example.com', Area: 'Hamdan Street', Commission: 5, JoinDate: '2021-03-10', Status: 'Active', Month: 'November', TotalRings: 3780, Answered: 1750, Missed: 2030, AvgWaitTime: '00:00:15', MaxWaitTime: '00:04:30', AvgTalkTime: '00:01:40', TotalTalkTime: '48:25:12', MissedRate: 53.70 },
      { ID: 209, Name: 'SALEH EMAD 202', Phone: '971 55 222 3344', Email: 'saleh@example.com', Area: 'Khalidiya', Commission: 4.5, JoinDate: '2020-08-15', Status: 'Active', Month: 'November', TotalRings: 2980, Answered: 1550, Missed: 1430, AvgWaitTime: '00:00:13', MaxWaitTime: '00:04:40', AvgTalkTime: '00:01:45', TotalTalkTime: '45:12:20', MissedRate: 48.00 },
      { ID: 210, Name: 'Nona Rose', Phone: '971 56 333 4455', Email: 'nona@example.com', Area: 'Muroor Road', Commission: 6, JoinDate: '2021-11-20', Status: 'Active', Month: 'November', TotalRings: 4650, Answered: 2650, Missed: 2000, AvgWaitTime: '00:00:10', MaxWaitTime: '00:03:45', AvgTalkTime: '00:02:05', TotalTalkTime: '90:15:30', MissedRate: 43.01 },
      { ID: 211, Name: 'manju ranabhat', Phone: '971 54 444 5566', Email: 'manju@example.com', Area: 'Al Barsha', Commission: 5.5, JoinDate: '2022-02-05', Status: 'Active', Month: 'November', TotalRings: 5700, Answered: 2850, Missed: 2850, AvgWaitTime: '00:00:12', MaxWaitTime: '00:04:45', AvgTalkTime: '00:01:35', TotalTalkTime: '80:30:45', MissedRate: 50.00 },
      { ID: 212, Name: 'Melvin compendio', Phone: '971 52 555 6677', Email: 'melvin@example.com', Area: 'Al Satwa', Commission: 4, JoinDate: '2021-07-12', Status: 'Active', Month: 'November', TotalRings: 2200, Answered: 1200, Missed: 1000, AvgWaitTime: '00:00:11', MaxWaitTime: '00:03:30', AvgTalkTime: '00:01:55', TotalTalkTime: '38:45:20', MissedRate: 45.45 },
      { ID: 213, Name: 'AGENT', Phone: '971 55 666 7788', Email: 'agent@example.com', Area: 'Al Reega', Commission: 7, JoinDate: '2022-05-18', Status: 'Active', Month: 'November', TotalRings: 2400, Answered: 1350, Missed: 1050, AvgWaitTime: '00:00:15', MaxWaitTime: '00:03:15', AvgTalkTime: '00:01:35', TotalTalkTime: '35:20:10', MissedRate: 43.75 },
      { ID: 214, Name: 'Asmita Sapkota', Phone: '971 50 777 8899', Email: 'asmita@example.com', Area: 'Hamdan Street', Commission: 5.5, JoinDate: '2021-09-18', Status: 'Active', Month: 'November', TotalRings: 4800, Answered: 2250, Missed: 2550, AvgWaitTime: '00:00:15', MaxWaitTime: '00:04:25', AvgTalkTime: '00:01:40', TotalTalkTime: '65:30:15', MissedRate: 53.13 },
      // December data
      { ID: 215, Name: 'Ann Areille David', Phone: '971 50 111 2233', Email: 'ann@example.com', Area: 'Hamdan Street', Commission: 5, JoinDate: '2021-03-10', Status: 'Active', Month: 'December', TotalRings: 3900, Answered: 1800, Missed: 2100, AvgWaitTime: '00:00:16', MaxWaitTime: '00:04:35', AvgTalkTime: '00:01:38', TotalTalkTime: '50:10:05', MissedRate: 53.85 },
      { ID: 216, Name: 'SALEH EMAD 202', Phone: '971 55 222 3344', Email: 'saleh@example.com', Area: 'Khalidiya', Commission: 4.5, JoinDate: '2020-08-15', Status: 'Active', Month: 'December', TotalRings: 3100, Answered: 1600, Missed: 1500, AvgWaitTime: '00:00:14', MaxWaitTime: '00:04:45', AvgTalkTime: '00:01:42', TotalTalkTime: '47:15:30', MissedRate: 48.39 },
      { ID: 217, Name: 'Nona Rose', Phone: '971 56 333 4455', Email: 'nona@example.com', Area: 'Muroor Road', Commission: 6, JoinDate: '2021-11-20', Status: 'Active', Month: 'December', TotalRings: 4800, Answered: 2750, Missed: 2050, AvgWaitTime: '00:00:11', MaxWaitTime: '00:03:50', AvgTalkTime: '00:02:03', TotalTalkTime: '95:05:20', MissedRate: 42.71 },
      { ID: 218, Name: 'manju ranabhat', Phone: '971 54 444 5566', Email: 'manju@example.com', Area: 'Al Barsha', Commission: 5.5, JoinDate: '2022-02-05', Status: 'Active', Month: 'December', TotalRings: 5900, Answered: 3000, Missed: 2900, AvgWaitTime: '00:00:13', MaxWaitTime: '00:04:50', AvgTalkTime: '00:01:33', TotalTalkTime: '85:45:30', MissedRate: 49.15 },
      { ID: 219, Name: 'Melvin compendio', Phone: '971 52 555 6677', Email: 'melvin@example.com', Area: 'Al Satwa', Commission: 4, JoinDate: '2021-07-12', Status: 'Active', Month: 'December', TotalRings: 2300, Answered: 1250, Missed: 1050, AvgWaitTime: '00:00:12', MaxWaitTime: '00:03:35', AvgTalkTime: '00:01:52', TotalTalkTime: '40:20:15', MissedRate: 45.65 },
      { ID: 220, Name: 'AGENT', Phone: '971 55 666 7788', Email: 'agent@example.com', Area: 'Al Reega', Commission: 7, JoinDate: '2022-05-18', Status: 'Active', Month: 'December', TotalRings: 2500, Answered: 1400, Missed: 1100, AvgWaitTime: '00:00:16', MaxWaitTime: '00:03:20', AvgTalkTime: '00:01:33', TotalTalkTime: '37:10:05', MissedRate: 44.00 },
      { ID: 221, Name: 'Asmita Sapkota', Phone: '971 50 777 8899', Email: 'asmita@example.com', Area: 'Hamdan Street', Commission: 5.5, JoinDate: '2021-09-18', Status: 'Active', Month: 'December', TotalRings: 4900, Answered: 2300, Missed: 2600, AvgWaitTime: '00:00:15', MaxWaitTime: '00:04:30', AvgTalkTime: '00:01:38', TotalTalkTime: '68:15:20', MissedRate: 53.06 }
    ],
    monthlySales: [
      { ID: 1, Branch: 'Crispy Chicken-Hamdan St', Year: 2025, Month: 1, DeliveryCount: 450, Percentage: 10, Amount: 12500 },
      { ID: 2, Branch: 'Crispy Chicken-Hamdan St', Year: 2025, Month: 2, DeliveryCount: 480, Percentage: 10, Amount: 13200 },
      { ID: 3, Branch: 'Crispy Chicken-Hamdan St', Year: 2025, Month: 3, DeliveryCount: 520, Percentage: 8, Amount: 14560 },
      { ID: 4, Branch: 'Crispy Chicken-Hamdan St', Year: 2025, Month: 4, DeliveryCount: 550, Percentage: 11, Amount: 15400 },
      { ID: 5, Branch: 'Crispy Chicken-Hamdan St', Year: 2025, Month: 5, DeliveryCount: 580, Percentage: 11, Amount: 16240 },
      { ID: 6, Branch: 'Crispy Chicken-Hamdan St', Year: 2025, Month: 6, DeliveryCount: 600, Percentage: 10, Amount: 16800 },
      { ID: 7, Branch: 'Crispy Chicken-Hamdan St', Year: 2025, Month: 7, DeliveryCount: 620, Percentage: 10, Amount: 17360 },
      { ID: 8, Branch: 'Crispy Chicken-Hamdan St', Year: 2025, Month: 8, DeliveryCount: 650, Percentage: 10, Amount: 18200 },
      { ID: 9, Branch: 'Crispy Chicken-Hamdan St', Year: 2025, Month: 9, DeliveryCount: 680, Percentage: 10, Amount: 19040 },
      { ID: 10, Branch: 'Crispy Chicken-Hamdan St', Year: 2025, Month: 10, DeliveryCount: 700, Percentage: 10, Amount: 19600 },
      { ID: 11, Branch: 'Crispy Chicken-Hamdan St', Year: 2025, Month: 11, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 12, Branch: 'Crispy Chicken-Hamdan St', Year: 2025, Month: 12, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      
      { ID: 13, Branch: 'Crispy chicken Shabiya 11', Year: 2025, Month: 1, DeliveryCount: 380, Percentage: 10, Amount: 10640 },
      { ID: 14, Branch: 'Crispy chicken Shabiya 11', Year: 2025, Month: 2, DeliveryCount: 400, Percentage: 10, Amount: 11200 },
      { ID: 15, Branch: 'Crispy chicken Shabiya 11', Year: 2025, Month: 3, DeliveryCount: 420, Percentage: 8, Amount: 11760 },
      { ID: 16, Branch: 'Crispy chicken Shabiya 11', Year: 2025, Month: 4, DeliveryCount: 450, Percentage: 11, Amount: 12600 },
      { ID: 17, Branch: 'Crispy chicken Shabiya 11', Year: 2025, Month: 5, DeliveryCount: 480, Percentage: 11, Amount: 13440 },
      { ID: 18, Branch: 'Crispy chicken Shabiya 11', Year: 2025, Month: 6, DeliveryCount: 500, Percentage: 10, Amount: 14000 },
      { ID: 19, Branch: 'Crispy chicken Shabiya 11', Year: 2025, Month: 7, DeliveryCount: 520, Percentage: 10, Amount: 14560 },
      { ID: 20, Branch: 'Crispy chicken Shabiya 11', Year: 2025, Month: 8, DeliveryCount: 550, Percentage: 10, Amount: 15400 },
      { ID: 21, Branch: 'Crispy chicken Shabiya 11', Year: 2025, Month: 9, DeliveryCount: 580, Percentage: 10, Amount: 16240 },
      { ID: 22, Branch: 'Crispy chicken Shabiya 11', Year: 2025, Month: 10, DeliveryCount: 600, Percentage: 10, Amount: 16800 },
      { ID: 23, Branch: 'Crispy chicken Shabiya 11', Year: 2025, Month: 11, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 24, Branch: 'Crispy chicken Shabiya 11', Year: 2025, Month: 12, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      
      { ID: 25, Branch: 'Crispy chicken khaldia', Year: 2025, Month: 1, DeliveryCount: 360, Percentage: 10, Amount: 10080 },
      { ID: 26, Branch: 'Crispy chicken khaldia', Year: 2025, Month: 2, DeliveryCount: 380, Percentage: 10, Amount: 10640 },
      { ID: 27, Branch: 'Crispy chicken khaldia', Year: 2025, Month: 3, DeliveryCount: 400, Percentage: 8, Amount: 11200 },
      { ID: 28, Branch: 'Crispy chicken khaldia', Year: 2025, Month: 4, DeliveryCount: 430, Percentage: 11, Amount: 12040 },
      { ID: 29, Branch: 'Crispy chicken khaldia', Year: 2025, Month: 5, DeliveryCount: 460, Percentage: 11, Amount: 12880 },
      { ID: 30, Branch: 'Crispy chicken khaldia', Year: 2025, Month: 6, DeliveryCount: 480, Percentage: 10, Amount: 13440 },
      { ID: 31, Branch: 'Crispy chicken khaldia', Year: 2025, Month: 7, DeliveryCount: 500, Percentage: 10, Amount: 14000 },
      { ID: 32, Branch: 'Crispy chicken khaldia', Year: 2025, Month: 8, DeliveryCount: 530, Percentage: 10, Amount: 14840 },
      { ID: 33, Branch: 'Crispy chicken khaldia', Year: 2025, Month: 9, DeliveryCount: 560, Percentage: 10, Amount: 15680 },
      { ID: 34, Branch: 'Crispy chicken khaldia', Year: 2025, Month: 10, DeliveryCount: 580, Percentage: 10, Amount: 16240 },
      { ID: 35, Branch: 'Crispy chicken khaldia', Year: 2025, Month: 11, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 36, Branch: 'Crispy chicken khaldia', Year: 2025, Month: 12, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      
      { ID: 37, Branch: 'Crispy chicken Elactra', Year: 2025, Month: 1, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 38, Branch: 'Crispy chicken Elactra', Year: 2025, Month: 2, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 39, Branch: 'Crispy chicken Elactra', Year: 2025, Month: 3, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 40, Branch: 'Crispy chicken Elactra', Year: 2025, Month: 4, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 41, Branch: 'Crispy chicken Elactra', Year: 2025, Month: 5, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 42, Branch: 'Crispy chicken Elactra', Year: 2025, Month: 6, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 43, Branch: 'Crispy chicken Elactra', Year: 2025, Month: 7, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 44, Branch: 'Crispy chicken Elactra', Year: 2025, Month: 8, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 45, Branch: 'Crispy chicken Elactra', Year: 2025, Month: 9, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 46, Branch: 'Crispy chicken Elactra', Year: 2025, Month: 10, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 47, Branch: 'Crispy chicken Elactra', Year: 2025, Month: 11, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 48, Branch: 'Crispy chicken Elactra', Year: 2025, Month: 12, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      
      { ID: 49, Branch: 'Crispy chicken Muroor', Year: 2025, Month: 1, DeliveryCount: 320, Percentage: 10, Amount: 8960 },
      { ID: 50, Branch: 'Crispy chicken Muroor', Year: 2025, Month: 2, DeliveryCount: 340, Percentage: 10, Amount: 9520 },
      { ID: 51, Branch: 'Crispy chicken Muroor', Year: 2025, Month: 3, DeliveryCount: 360, Percentage: 8, Amount: 10080 },
      { ID: 52, Branch: 'Crispy chicken Muroor', Year: 2025, Month: 4, DeliveryCount: 390, Percentage: 11, Amount: 10920 },
      { ID: 53, Branch: 'Crispy chicken Muroor', Year: 2025, Month: 5, DeliveryCount: 420, Percentage: 11, Amount: 11760 },
      { ID: 54, Branch: 'Crispy chicken Muroor', Year: 2025, Month: 6, DeliveryCount: 440, Percentage: 10, Amount: 12320 },
      { ID: 55, Branch: 'Crispy chicken Muroor', Year: 2025, Month: 7, DeliveryCount: 460, Percentage: 10, Amount: 12880 },
      { ID: 56, Branch: 'Crispy chicken Muroor', Year: 2025, Month: 8, DeliveryCount: 490, Percentage: 10, Amount: 13720 },
      { ID: 57, Branch: 'Crispy chicken Muroor', Year: 2025, Month: 9, DeliveryCount: 520, Percentage: 10, Amount: 14560 },
      { ID: 58, Branch: 'Crispy chicken Muroor', Year: 2025, Month: 10, DeliveryCount: 540, Percentage: 10, Amount: 15120 },
      { ID: 59, Branch: 'Crispy chicken Muroor', Year: 2025, Month: 11, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 60, Branch: 'Crispy chicken Muroor', Year: 2025, Month: 12, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      
      { ID: 61, Branch: 'Crispy chicken Al Barsha', Year: 2025, Month: 1, DeliveryCount: 420, Percentage: 10, Amount: 11760 },
      { ID: 62, Branch: 'Crispy chicken Al Barsha', Year: 2025, Month: 2, DeliveryCount: 440, Percentage: 10, Amount: 12320 },
      { ID: 63, Branch: 'Crispy chicken Al Barsha', Year: 2025, Month: 3, DeliveryCount: 460, Percentage: 8, Amount: 12880 },
      { ID: 64, Branch: 'Crispy chicken Al Barsha', Year: 2025, Month: 4, DeliveryCount: 490, Percentage: 11, Amount: 13720 },
      { ID: 65, Branch: 'Crispy chicken Al Barsha', Year: 2025, Month: 5, DeliveryCount: 520, Percentage: 11, Amount: 14560 },
      { ID: 66, Branch: 'Crispy chicken Al Barsha', Year: 2025, Month: 6, DeliveryCount: 540, Percentage: 10, Amount: 15120 },
      { ID: 67, Branch: 'Crispy chicken Al Barsha', Year: 2025, Month: 7, DeliveryCount: 560, Percentage: 10, Amount: 15680 },
      { ID: 68, Branch: 'Crispy chicken Al Barsha', Year: 2025, Month: 8, DeliveryCount: 590, Percentage: 10, Amount: 16520 },
      { ID: 69, Branch: 'Crispy chicken Al Barsha', Year: 2025, Month: 9, DeliveryCount: 620, Percentage: 10, Amount: 17360 },
      { ID: 70, Branch: 'Crispy chicken Al Barsha', Year: 2025, Month: 10, DeliveryCount: 640, Percentage: 10, Amount: 17920 },
      { ID: 71, Branch: 'Crispy chicken Al Barsha', Year: 2025, Month: 11, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 72, Branch: 'Crispy chicken Al Barsha', Year: 2025, Month: 12, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      
      { ID: 73, Branch: 'Crispy chicken Al Satwa', Year: 2025, Month: 1, DeliveryCount: 380, Percentage: 10, Amount: 10640 },
      { ID: 74, Branch: 'Crispy chicken Al Satwa', Year: 2025, Month: 2, DeliveryCount: 400, Percentage: 10, Amount: 11200 },
      { ID: 75, Branch: 'Crispy chicken Al Satwa', Year: 2025, Month: 3, DeliveryCount: 420, Percentage: 8, Amount: 11760 },
      { ID: 76, Branch: 'Crispy chicken Al Satwa', Year: 2025, Month: 4, DeliveryCount: 450, Percentage: 11, Amount: 12600 },
      { ID: 77, Branch: 'Crispy chicken Al Satwa', Year: 2025, Month: 5, DeliveryCount: 480, Percentage: 11, Amount: 13440 },
      { ID: 78, Branch: 'Crispy chicken Al Satwa', Year: 2025, Month: 6, DeliveryCount: 500, Percentage: 10, Amount: 14000 },
      { ID: 79, Branch: 'Crispy chicken Al Satwa', Year: 2025, Month: 7, DeliveryCount: 520, Percentage: 10, Amount: 14560 },
      { ID: 80, Branch: 'Crispy chicken Al Satwa', Year: 2025, Month: 8, DeliveryCount: 550, Percentage: 10, Amount: 15400 },
      { ID: 81, Branch: 'Crispy chicken Al Satwa', Year: 2025, Month: 9, DeliveryCount: 580, Percentage: 10, Amount: 16240 },
      { ID: 82, Branch: 'Crispy chicken Al Satwa', Year: 2025, Month: 10, DeliveryCount: 600, Percentage: 10, Amount: 16800 },
      { ID: 83, Branch: 'Crispy chicken Al Satwa', Year: 2025, Month: 11, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 84, Branch: 'Crispy chicken Al Satwa', Year: 2025, Month: 12, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      
      { ID: 85, Branch: 'Crispy chicken Al Regga', Year: 2025, Month: 1, DeliveryCount: 300, Percentage: 10, Amount: 8400 },
      { ID: 86, Branch: 'Crispy chicken Al Regga', Year: 2025, Month: 2, DeliveryCount: 320, Percentage: 10, Amount: 8960 },
      { ID: 87, Branch: 'Crispy chicken Al Regga', Year: 2025, Month: 3, DeliveryCount: 340, Percentage: 8, Amount: 9520 },
      { ID: 88, Branch: 'Crispy chicken Al Regga', Year: 2025, Month: 4, DeliveryCount: 370, Percentage: 11, Amount: 10360 },
      { ID: 89, Branch: 'Crispy chicken Al Regga', Year: 2025, Month: 5, DeliveryCount: 400, Percentage: 11, Amount: 11200 },
      { ID: 90, Branch: 'Crispy chicken Al Regga', Year: 2025, Month: 6, DeliveryCount: 420, Percentage: 10, Amount: 11760 },
      { ID: 91, Branch: 'Crispy chicken Al Regga', Year: 2025, Month: 7, DeliveryCount: 440, Percentage: 10, Amount: 12320 },
      { ID: 92, Branch: 'Crispy chicken Al Regga', Year: 2025, Month: 8, DeliveryCount: 470, Percentage: 10, Amount: 13160 },
      { ID: 93, Branch: 'Crispy chicken Al Regga', Year: 2025, Month: 9, DeliveryCount: 500, Percentage: 10, Amount: 14000 },
      { ID: 94, Branch: 'Crispy chicken Al Regga', Year: 2025, Month: 10, DeliveryCount: 520, Percentage: 10, Amount: 14560 },
      { ID: 95, Branch: 'Crispy chicken Al Regga', Year: 2025, Month: 11, DeliveryCount: 0, Percentage: 0, Amount: 0 },
      { ID: 96, Branch: 'Crispy chicken Al Regga', Year: 2025, Month: 12, DeliveryCount: 0, Percentage: 0, Amount: 0 }
    ]
  };
  
  let sampleData = {};
  let timestamps = {};
  
  // --- INITIALIZATION ---
  document.addEventListener('DOMContentLoaded', function() {
    loadDataFromStorage();
    initializeNavigation();
    initializeMap();
    initializeKeyboardShortcuts();
    loadAllData();
  });
  
  // --- DATA PERSISTENCE FUNCTIONS ---
  function loadDataFromStorage() {
    try {
      // Load data from localStorage
      const storedData = localStorage.getItem(STORAGE_KEY);
      if (storedData) {
        sampleData = JSON.parse(storedData);
      } else {
        // Use default data if nothing is stored
        sampleData = JSON.parse(JSON.stringify(defaultSampleData));
        saveDataToStorage();
      }
      
      // Load timestamps
      const storedTimestamps = localStorage.getItem(TIMESTAMP_KEY);
      if (storedTimestamps) {
        timestamps = JSON.parse(storedTimestamps);
        updateTimestampDisplays();
      }
    } catch (error) {
      console.error('Error loading data from storage:', error);
      showToast('Error loading data. Using default data.', 'error');
      sampleData = JSON.parse(JSON.stringify(defaultSampleData));
    }
  }
  
  function saveDataToStorage() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(sampleData));
      localStorage.setItem(TIMESTAMP_KEY, JSON.stringify(timestamps));
    } catch (error) {
      console.error('Error saving data to storage:', error);
      showToast('Error saving data. Changes may not be persisted.', 'error');
    }
  }
  
  function updateTimestamp(section) {
    const now = new Date();
    const formattedTime = now.toLocaleString();
    timestamps[section] = formattedTime;
    saveDataToStorage();
    updateTimestampDisplays();
  }
  
  function updateTimestampDisplays() {
    // Update dashboard timestamps
    if (timestamps.branches) {
      document.getElementById('branches-timestamp').textContent = `Last updated: ${timestamps.branches}`;
    }
    if (timestamps.drivers) {
      document.getElementById('drivers-timestamp').textContent = `Last updated: ${timestamps.drivers}`;
    }
    if (timestamps.managers) {
      document.getElementById('managers-timestamp').textContent = `Last updated: ${timestamps.managers}`;
    }
    if (timestamps.agents) {
      document.getElementById('agents-timestamp').textContent = `Last updated: ${timestamps.agents}`;
    }
    if (timestamps.sales) {
      document.getElementById('sales-timestamp').textContent = `Last updated: ${timestamps.sales}`;
    }
  }
  
  function resetData() {
    showConfirmDialog(
      'Reset Data',
      'Are you sure you want to reset all data to default values? This action cannot be undone.',
      function() {
        sampleData = JSON.parse(JSON.stringify(defaultSampleData));
        timestamps = {};
        saveDataToStorage();
        loadAllData();
        showToast('Data has been reset to default values.', 'success');
      }
    );
  }
  
  // --- NAVIGATION ---
  function initializeNavigation() {
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const section = this.getAttribute('data-section');
        switchSection(section);
        
        // Update active nav link
        navLinks.forEach(l => l.classList.remove('active'));
        this.classList.add('active');
      });
    });
  }
  
  function switchSection(section) {
    // Hide all sections
    const sections = document.querySelectorAll('.data-section');
    sections.forEach(s => s.classList.remove('active'));
    
    // Show selected section
    document.getElementById(`${section}-section`).classList.add('active');
    activeSection = section;
    
    // Initialize section-specific functionality
    if (section === 'branches') {
      renderBranches();
    } else if (section === 'drivers') {
      renderDrivers();
    } else if (section === 'managers') {
      renderManagers();
    } else if (section === 'agents') {
      renderAgents();
    } else if (section === 'sales') {
      renderMonthlySales();
    }
  }
  
  // --- MAP FUNCTIONS ---
  function initializeMap() {
    map = L.map('map').setView([24.4539, 54.3773], 11); // Centered on Abu Dhabi
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
  }
  
  function updateBranchMarkers() {
    // Clear existing markers
    branchMarkers.forEach(marker => map.removeLayer(marker));
    branchMarkers = [];
    
    // Add markers for each branch
    sampleData.branches.forEach(branch => {
      if (branch.direction && branch.direction !== 'new brunch') {
        const coords = branch.direction.split(',').map(Number);
        if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
          const marker = L.marker(coords).addTo(map);
          marker.bindPopup(`
            <b>${branch['Branch Name']}</b><br>
            ${branch.AREA}<br>
            Manager: ${branch['Manger name']}<br>
            <a href="#" onclick="openBranchForm(${branch.ID})">Edit Details</a>
          `);
          branchMarkers.push(marker);
        }
      }
    });
  }
  
  // --- DATA LOADING ---
  function loadAllData() {
    // Update dashboard counters
    updateDashboardCounters();
    
    // Update branch markers on map
    updateBranchMarkers();
  }
  
  function updateDashboardCounters() {
    document.getElementById('total-branches').textContent = sampleData.branches.length;
    document.getElementById('total-drivers').textContent = sampleData.drivers.length;
    document.getElementById('total-managers').textContent = sampleData.managers.length;
    document.getElementById('total-agents').textContent = sampleData.agents.length;
    
    // Calculate total sales
    const totalSales = sampleData.monthlySales.reduce((sum, sale) => sum + sale.Amount, 0);
    document.getElementById('total-sales').textContent = `AED ${totalSales.toLocaleString()}`;
    
    // Calculate active branches
    const activeBranches = sampleData.branches.filter(b => b['Delivery status'] === 'Yes').length;
    document.getElementById('active-branches').textContent = activeBranches;
    
    // Calculate total bikes
    let totalBikes = 0;
    sampleData.branches.forEach(branch => {
      totalBikes += parseInt(branch['Number bikes'] || 0);
    });
    document.getElementById('total-bikes').textContent = totalBikes;
    
    // Calculate total staff
    const totalStaff = sampleData.drivers.length + sampleData.managers.length + sampleData.agents.length;
    document.getElementById('total-staff').textContent = totalStaff;
  }
  
  // --- BRANCH MANAGEMENT ---
  function renderBranches() {
    const tbody = document.getElementById('branch-table-body');
    tbody.innerHTML = '';
    
    sampleData.branches.forEach(branch => {
      const row = tbody.insertRow();
      const statusClass = branch['Delivery status'] === 'Yes' ? 'status-active' : 'status-inactive';
      
      row.innerHTML = `
        <td>${branch.ID}</td>
        <td>${branch['Branch Name']}</td>
        <td>${branch.City}</td>
        <td>${branch.AREA}</td>
        <td>${branch['Manger name']}</td>
        <td><span class="status-badge ${statusClass}">${branch['Delivery status']}</span></td>
        <td>
          <button class="action-btn tooltip" onclick="openBranchForm(${branch.ID})" title="Edit">
            <i class="fas fa-edit"></i>
            <span class="tooltiptext">Edit Branch</span>
          </button>
          <button class="action-btn delete tooltip" onclick="confirmDeleteBranch(${branch.ID})" title="Delete">
            <i class="fas fa-trash"></i>
            <span class="tooltiptext">Delete Branch</span>
          </button>
        </td>
      `;
    });
    
    // Initialize search
    const searchInput = document.getElementById('branch-search');
    searchInput.addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase();
      const filteredData = sampleData.branches.filter(branch => 
        branch['Branch Name'].toLowerCase().includes(searchTerm) ||
        branch.City.toLowerCase().includes(searchTerm) ||
        branch.AREA.toLowerCase().includes(searchTerm)
      );
      
      tbody.innerHTML = '';
      filteredData.forEach(branch => {
        const row = tbody.insertRow();
        const statusClass = branch['Delivery status'] === 'Yes' ? 'status-active' : 'status-inactive';
        
        row.innerHTML = `
          <td>${branch.ID}</td>
          <td>${branch['Branch Name']}</td>
          <td>${branch.City}</td>
          <td>${branch.AREA}</td>
          <td>${branch['Manger name']}</td>
          <td><span class="status-badge ${statusClass}">${branch['Delivery status']}</span></td>
          <td>
            <button class="action-btn tooltip" onclick="openBranchForm(${branch.ID})" title="Edit">
              <i class="fas fa-edit"></i>
              <span class="tooltiptext">Edit Branch</span>
            </button>
            <button class="action-btn delete tooltip" onclick="confirmDeleteBranch(${branch.ID})" title="Delete">
              <i class="fas fa-trash"></i>
              <span class="tooltiptext">Delete Branch</span>
            </button>
          </td>
        `;
      });
    });
  }
  
  function openBranchForm(id = null) {
    const formPopup = document.getElementById('branch-form-popup');
    formPopup.style.display = 'flex';
    
    // Reset form changes tracking
    formHasChanges['branch-form'] = false;
    
    // Populate manager dropdown
    const managerSelect = document.getElementById('branch-manager');
    managerSelect.innerHTML = '<option value="">Select Manager</option>';
    sampleData.managers.forEach(manager => {
      const option = document.createElement('option');
      option.value = manager.Name;
      option.textContent = manager.Name;
      managerSelect.appendChild(option);
    });
    
    if (id) {
      // Edit existing branch
      const branch = sampleData.branches.find(b => b.ID === id);
      if (branch) {
        document.getElementById('branch-form-title').textContent = 'Edit Branch';
        document.getElementById('branch-submit-btn').textContent = 'Update Branch';
        document.getElementById('branch-edit-id').value = branch.ID;
        document.getElementById('branch-delete-btn').style.display = 'inline-block';
        
        // Populate form fields
        document.getElementById('branch-name').value = branch['Branch Name'];
        document.getElementById('branch-city').value = branch.City;
        document.getElementById('branch-direction').value = branch.direction;
        document.getElementById('branch-area').value = branch.AREA;
        document.getElementById('branch-landline').value = branch['Land line'];
        document.getElementById('branch-google-site').value = branch['Google site'];
        document.getElementById('branch-rate').value = branch.RATE;
        document.getElementById('branch-manager').value = branch['Manger name'];
        document.getElementById('branch-email').value = branch['Email address'];
        document.getElementById('branch-delivery-status').value = branch['Delivery status'];
        document.getElementById('branch-link-online').value = branch['Link online'];
        document.getElementById('branch-num-bikes').value = branch['Number bikes'];
        document.getElementById('branch-num-drivers').value = branch['Number driver'];
        document.getElementById('branch-talabat-device').value = branch['Talabat device'];
        document.getElementById('branch-noon-device').value = branch['Noon device'];
        document.getElementById('branch-careem-device').value = branch['Careen device'];
        document.getElementById('branch-deliveroo-device').value = branch['Deliveroo device'];
        document.getElementById('branch-smile-device').value = branch['Smile device'];
        document.getElementById('branch-talabana-device').value = branch['Talabana device'];
      }
    } else {
      // Add new branch
      document.getElementById('branch-form-title').textContent = 'Add New Branch';
      document.getElementById('branch-submit-btn').textContent = 'Save Branch';
      document.getElementById('branch-edit-id').value = '';
      document.getElementById('branch-delete-btn').style.display = 'none';
      document.getElementById('branch-form').reset();
    }
    
    // Track form changes
    trackFormChanges('branch-form');
  }
  
  function submitBranchForm(e) {
    e.preventDefault();
    
    // Validate form
    if (!validateForm('branch-form')) {
      showToast('Please fix the errors in the form', 'error');
      return;
    }
    
    showLoadingOverlay();
    
    const branchId = document.getElementById('branch-edit-id').value;
    const branchData = {
      'Branch Name': document.getElementById('branch-name').value,
      City: document.getElementById('branch-city').value,
      direction: document.getElementById('branch-direction').value,
      AREA: document.getElementById('branch-area').value,
      'Land line': document.getElementById('branch-landline').value,
      'Google site': document.getElementById('branch-google-site').value,
      RATE: document.getElementById('branch-rate').value,
      'Manger name': document.getElementById('branch-manager').value,
      'Email address': document.getElementById('branch-email').value,
      'Delivery status': document.getElementById('branch-delivery-status').value,
      'Link online': document.getElementById('branch-link-online').value,
      'Number bikes': document.getElementById('branch-num-bikes').value,
      'Number driver': document.getElementById('branch-num-drivers').value,
      'Talabat device': document.getElementById('branch-talabat-device').value,
      'Noon device': document.getElementById('branch-noon-device').value,
      'Careen device': document.getElementById('branch-careem-device').value,
      'Deliveroo device': document.getElementById('branch-deliveroo-device').value,
      'Smile device': document.getElementById('branch-smile-device').value,
      'Talabana device': document.getElementById('branch-talabana-device').value
    };
    
    try {
      if (branchId) {
        // Update existing branch
        const index = sampleData.branches.findIndex(b => b.ID == branchId);
        if (index !== -1) {
          sampleData.branches[index] = { ...sampleData.branches[index], ...branchData };
          showToast('Branch updated successfully', 'success');
        }
      } else {
        // Add new branch
        const newId = Math.max(...sampleData.branches.map(b => b.ID), 0) + 1;
        sampleData.branches.push({ ID: newId, ...branchData });
        showToast('Branch added successfully', 'success');
      }
      
      // Update timestamp and save data
      updateTimestamp('branches');
      saveDataToStorage();
      
      closeForm('branch-form-popup');
      renderBranches();
      updateDashboardCounters();
      updateBranchMarkers();
    } catch (error) {
      console.error('Error saving branch:', error);
      showToast('Error saving branch. Please try again.', 'error');
    } finally {
      hideLoadingOverlay();
    }
  }
  
  function confirmDeleteBranch(id) {
    showConfirmDialog(
      'Delete Branch',
      'Are you sure you want to delete this branch? This action cannot be undone.',
      function() {
        deleteBranch(id);
      }
    );
  }
  
  function deleteBranch(id) {
    showLoadingOverlay();
    
    try {
      sampleData.branches = sampleData.branches.filter(b => b.ID !== id);
      updateTimestamp('branches');
      saveDataToStorage();
      
      showToast('Branch deleted successfully', 'success');
      renderBranches();
      updateDashboardCounters();
      updateBranchMarkers();
    } catch (error) {
      console.error('Error deleting branch:', error);
      showToast('Error deleting branch. Please try again.', 'error');
    } finally {
      hideLoadingOverlay();
    }
  }
  
  // --- DRIVER MANAGEMENT ---
  function renderDrivers() {
    const tbody = document.getElementById('driver-table-body');
    tbody.innerHTML = '';
    
    // Update driver statistics
    updateDriverStatistics();
    
    sampleData.drivers.forEach(driver => {
      const row = tbody.insertRow();
      const statusClass = driver.Status === 'Active' ? 'status-active' : 'status-inactive';
      
      // Check if license is expired
      const licenseExpiry = new Date(driver.LicenseExpiry);
      const today = new Date();
      const isExpired = licenseExpiry < today;
      
      row.innerHTML = `
        <td>${driver.ID}</td>
        <td>${driver.Name}</td>
        <td>${driver.MobileNumber}</td>
        <td>${driver.BikeNumber}</td>
        <td>${driver.Outlet}</td>
        <td>${driver.PlateNumber}</td>
        <td style="color: ${isExpired ? 'var(--danger-red)' : ''}">${driver.LicenseExpiry}</td>
        <td><span class="status-badge ${statusClass}">${driver.Status}</span></td>
        <td>
          <button class="action-btn tooltip" onclick="openDriverForm(${driver.ID})" title="Edit">
            <i class="fas fa-edit"></i>
            <span class="tooltiptext">Edit Driver</span>
          </button>
          <button class="action-btn delete tooltip" onclick="confirmDeleteDriver(${driver.ID})" title="Delete">
            <i class="fas fa-trash"></i>
            <span class="tooltiptext">Delete Driver</span>
          </button>
        </td>
      `;
    });
    
    // Initialize search
    const searchInput = document.getElementById('driver-search');
    searchInput.addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase();
      const filteredData = sampleData.drivers.filter(driver => 
        driver.Name.toLowerCase().includes(searchTerm) ||
        driver.MobileNumber.toLowerCase().includes(searchTerm) ||
        driver.BikeNumber.toLowerCase().includes(searchTerm) ||
        driver.Outlet.toLowerCase().includes(searchTerm)
      );
      
      tbody.innerHTML = '';
      filteredData.forEach(driver => {
        const row = tbody.insertRow();
        const statusClass = driver.Status === 'Active' ? 'status-active' : 'status-inactive';
        
        // Check if license is expired
        const licenseExpiry = new Date(driver.LicenseExpiry);
        const today = new Date();
        const isExpired = licenseExpiry < today;
        
        row.innerHTML = `
          <td>${driver.ID}</td>
          <td>${driver.Name}</td>
          <td>${driver.MobileNumber}</td>
          <td>${driver.BikeNumber}</td>
          <td>${driver.Outlet}</td>
          <td>${driver.PlateNumber}</td>
          <td style="color: ${isExpired ? 'var(--danger-red)' : ''}">${driver.LicenseExpiry}</td>
          <td><span class="status-badge ${statusClass}">${driver.Status}</span></td>
          <td>
            <button class="action-btn tooltip" onclick="openDriverForm(${driver.ID})" title="Edit">
              <i class="fas fa-edit"></i>
              <span class="tooltiptext">Edit Driver</span>
            </button>
            <button class="action-btn delete tooltip" onclick="confirmDeleteDriver(${driver.ID})" title="Delete">
              <i class="fas fa-trash"></i>
              <span class="tooltiptext">Delete Driver</span>
            </button>
          </td>
        `;
      });
    });
  }
  
  function updateDriverStatistics() {
    const totalDrivers = sampleData.drivers.length;
    const activeDrivers = sampleData.drivers.filter(d => d.Status === 'Active').length;
    const inactiveDrivers = sampleData.drivers.filter(d => d.Status === 'Inactive').length;
    
    // Calculate expired licenses
    let expiredLicenses = 0;
    sampleData.drivers.forEach(driver => {
      if (driver.LicenseExpiry) {
        const licenseExpiry = new Date(driver.LicenseExpiry);
        const today = new Date();
        if (licenseExpiry < today) {
          expiredLicenses++;
        }
      }
    });
    
    document.getElementById('driver-total-count').textContent = totalDrivers;
    document.getElementById('driver-active-count').textContent = activeDrivers;
    document.getElementById('driver-inactive-count').textContent = inactiveDrivers;
    document.getElementById('driver-expired-count').textContent = expiredLicenses;
  }
  
  function openDriverForm(id = null) {
    const formPopup = document.getElementById('driver-form-popup');
    formPopup.style.display = 'flex';
    
    // Reset form changes tracking
    formHasChanges['driver-form'] = false;
    
    // Populate outlet dropdown
    const outletSelect = document.getElementById('driver-outlet');
    outletSelect.innerHTML = '<option value="">Select Outlet</option>';
    sampleData.branches.forEach(branch => {
      const option = document.createElement('option');
      option.value = branch['Branch Name'];
      option.textContent = branch['Branch Name'];
      outletSelect.appendChild(option);
    });
    
    if (id) {
      // Edit existing driver
      const driver = sampleData.drivers.find(d => d.ID === id);
      if (driver) {
        document.getElementById('driver-form-title').textContent = 'Edit Driver';
        document.getElementById('driver-submit-btn').textContent = 'Update Driver';
        document.getElementById('driver-edit-id').value = driver.ID;
        document.getElementById('driver-delete-btn').style.display = 'inline-block';
        
        // Populate form fields
        document.getElementById('driver-name').value = driver.Name;
        document.getElementById('driver-mobile').value = driver.MobileNumber;
        document.getElementById('driver-bike-number').value = driver.BikeNumber;
        document.getElementById('driver-outlet').value = driver.Outlet;
        document.getElementById('driver-plate-number').value = driver.PlateNumber;
        document.getElementById('driver-license-expiry').value = formatDateForInput(driver.LicenseExpiry);
        document.getElementById('driver-traffic-code').value = driver.TrafficCode;
        document.getElementById('driver-document-number').value = driver.DocumentNumber;
        document.getElementById('driver-ownership-expiry').value = formatDateForInput(driver.OwnershipExpiry);
        document.getElementById('driver-driving-license').value = driver.DrivingLicenseNo;
        document.getElementById('driver-driving-license-expiry').value = formatDateForInput(driver.DrivingLicenseExpiry);
        document.getElementById('driver-join-date').value = formatDateForInput(driver.JoinDate);
        document.getElementById('driver-salary').value = driver.Salary;
        document.getElementById('driver-status').value = driver.Status;
      }
    } else {
      // Add new driver
      document.getElementById('driver-form-title').textContent = 'Add New Driver';
      document.getElementById('driver-submit-btn').textContent = 'Save Driver';
      document.getElementById('driver-edit-id').value = '';
      document.getElementById('driver-delete-btn').style.display = 'none';
      document.getElementById('driver-form').reset();
    }
    
    // Track form changes
    trackFormChanges('driver-form');
  }
  
  function submitDriverForm(e) {
    e.preventDefault();
    
    // Validate form
    if (!validateForm('driver-form')) {
      showToast('Please fix the errors in the form', 'error');
      return;
    }
    
    showLoadingOverlay();
    
    const driverId = document.getElementById('driver-edit-id').value;
    const driverData = {
      Name: document.getElementById('driver-name').value,
      MobileNumber: document.getElementById('driver-mobile').value,
      BikeNumber: document.getElementById('driver-bike-number').value,
      Outlet: document.getElementById('driver-outlet').value,
      PlateNumber: document.getElementById('driver-plate-number').value,
      LicenseExpiry: formatDateForStorage(document.getElementById('driver-license-expiry').value),
      TrafficCode: document.getElementById('driver-traffic-code').value,
      DocumentNumber: document.getElementById('driver-document-number').value,
      OwnershipExpiry: formatDateForStorage(document.getElementById('driver-ownership-expiry').value),
      DrivingLicenseNo: document.getElementById('driver-driving-license').value,
      DrivingLicenseExpiry: formatDateForStorage(document.getElementById('driver-driving-license-expiry').value),
      JoinDate: formatDateForStorage(document.getElementById('driver-join-date').value),
      Salary: parseFloat(document.getElementById('driver-salary').value) || 0,
      Status: document.getElementById('driver-status').value
    };
    
    try {
      if (driverId) {
        // Update existing driver
        const index = sampleData.drivers.findIndex(d => d.ID == driverId);
        if (index !== -1) {
          sampleData.drivers[index] = { ...sampleData.drivers[index], ...driverData };
          showToast('Driver updated successfully', 'success');
        }
      } else {
        // Add new driver
        const newId = Math.max(...sampleData.drivers.map(d => d.ID), 0) + 1;
        sampleData.drivers.push({ ID: newId, ...driverData });
        showToast('Driver added successfully', 'success');
      }
      
      // Update timestamp and save data
      updateTimestamp('drivers');
      saveDataToStorage();
      
      closeForm('driver-form-popup');
      renderDrivers();
      updateDashboardCounters();
    } catch (error) {
      console.error('Error saving driver:', error);
      showToast('Error saving driver. Please try again.', 'error');
    } finally {
      hideLoadingOverlay();
    }
  }
  
  function confirmDeleteDriver(id) {
    showConfirmDialog(
      'Delete Driver',
      'Are you sure you want to delete this driver? This action cannot be undone.',
      function() {
        deleteDriver(id);
      }
    );
  }
  
  function deleteDriver(id) {
    showLoadingOverlay();
    
    try {
      sampleData.drivers = sampleData.drivers.filter(d => d.ID !== id);
      updateTimestamp('drivers');
      saveDataToStorage();
      
      showToast('Driver deleted successfully', 'success');
      renderDrivers();
      updateDashboardCounters();
    } catch (error) {
      console.error('Error deleting driver:', error);
      showToast('Error deleting driver. Please try again.', 'error');
    } finally {
      hideLoadingOverlay();
    }
  }
  
  // --- MANAGER MANAGEMENT ---
  function renderManagers() {
    const tbody = document.getElementById('manager-table-body');
    tbody.innerHTML = '';
    
    sampleData.managers.forEach(manager => {
      const row = tbody.insertRow();
      const statusClass = manager.Status === 'Active' ? 'status-active' : 'status-inactive';
      
      row.innerHTML = `
        <td>${manager.ID}</td>
        <td>${manager.Name}</td>
        <td>${manager.Phone}</td>
        <td>${manager.Email}</td>
        <td>${manager.Branch}</td>
        <td><span class="status-badge ${statusClass}">${manager.Status}</span></td>
        <td>
          <button class="action-btn tooltip" onclick="openManagerForm(${manager.ID})" title="Edit">
            <i class="fas fa-edit"></i>
            <span class="tooltiptext">Edit Manager</span>
          </button>
          <button class="action-btn delete tooltip" onclick="confirmDeleteManager(${manager.ID})" title="Delete">
            <i class="fas fa-trash"></i>
            <span class="tooltiptext">Delete Manager</span>
          </button>
        </td>
      `;
    });
    
    // Initialize search
    const searchInput = document.getElementById('manager-search');
    searchInput.addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase();
      const filteredData = sampleData.managers.filter(manager => 
        manager.Name.toLowerCase().includes(searchTerm) ||
        manager.Phone.toLowerCase().includes(searchTerm) ||
        manager.Email.toLowerCase().includes(searchTerm) ||
        manager.Branch.toLowerCase().includes(searchTerm)
      );
      
      tbody.innerHTML = '';
      filteredData.forEach(manager => {
        const row = tbody.insertRow();
        const statusClass = manager.Status === 'Active' ? 'status-active' : 'status-inactive';
        
        row.innerHTML = `
          <td>${manager.ID}</td>
          <td>${manager.Name}</td>
          <td>${manager.Phone}</td>
          <td>${manager.Email}</td>
          <td>${manager.Branch}</td>
          <td><span class="status-badge ${statusClass}">${manager.Status}</span></td>
          <td>
            <button class="action-btn tooltip" onclick="openManagerForm(${manager.ID})" title="Edit">
              <i class="fas fa-edit"></i>
              <span class="tooltiptext">Edit Manager</span>
            </button>
            <button class="action-btn delete tooltip" onclick="confirmDeleteManager(${manager.ID})" title="Delete">
              <i class="fas fa-trash"></i>
              <span class="tooltiptext">Delete Manager</span>
            </button>
          </td>
        `;
      });
    });
  }
  
  function openManagerForm(id = null) {
    const formPopup = document.getElementById('manager-form-popup');
    formPopup.style.display = 'flex';
    
    // Reset form changes tracking
    formHasChanges['manager-form'] = false;
    
    // Populate branch dropdown
    const branchSelect = document.getElementById('manager-branch');
    branchSelect.innerHTML = '<option value="">Select Branch</option>';
    sampleData.branches.forEach(branch => {
      const option = document.createElement('option');
      option.value = branch['Branch Name'];
      option.textContent = branch['Branch Name'];
      branchSelect.appendChild(option);
    });
    
    if (id) {
      // Edit existing manager
      const manager = sampleData.managers.find(m => m.ID === id);
      if (manager) {
        document.getElementById('manager-form-title').textContent = 'Edit Manager';
        document.getElementById('manager-submit-btn').textContent = 'Update Manager';
        document.getElementById('manager-edit-id').value = manager.ID;
        document.getElementById('manager-delete-btn').style.display = 'inline-block';
        
        // Populate form fields
        document.getElementById('manager-name').value = manager.Name;
        document.getElementById('manager-phone').value = manager.Phone;
        document.getElementById('manager-email').value = manager.Email;
        document.getElementById('manager-branch').value = manager.Branch;
        document.getElementById('manager-join-date').value = formatDateForInput(manager.JoinDate);
        document.getElementById('manager-salary').value = manager.Salary;
        document.getElementById('manager-status').value = manager.Status;
      }
    } else {
      // Add new manager
      document.getElementById('manager-form-title').textContent = 'Add New Manager';
      document.getElementById('manager-submit-btn').textContent = 'Save Manager';
      document.getElementById('manager-edit-id').value = '';
      document.getElementById('manager-delete-btn').style.display = 'none';
      document.getElementById('manager-form').reset();
    }
    
    // Track form changes
    trackFormChanges('manager-form');
  }
  
  function submitManagerForm(e) {
    e.preventDefault();
    
    // Validate form
    if (!validateForm('manager-form')) {
      showToast('Please fix the errors in the form', 'error');
      return;
    }
    
    showLoadingOverlay();
    
    const managerId = document.getElementById('manager-edit-id').value;
    const managerData = {
      Name: document.getElementById('manager-name').value,
      Phone: document.getElementById('manager-phone').value,
      Email: document.getElementById('manager-email').value,
      Branch: document.getElementById('manager-branch').value,
      JoinDate: formatDateForStorage(document.getElementById('manager-join-date').value),
      Salary: parseFloat(document.getElementById('manager-salary').value) || 0,
      Status: document.getElementById('manager-status').value
    };
    
    try {
      if (managerId) {
        // Update existing manager
        const index = sampleData.managers.findIndex(m => m.ID == managerId);
        if (index !== -1) {
          sampleData.managers[index] = { ...sampleData.managers[index], ...managerData };
          showToast('Manager updated successfully', 'success');
        }
      } else {
        // Add new manager
        const newId = Math.max(...sampleData.managers.map(m => m.ID), 0) + 1;
        sampleData.managers.push({ ID: newId, ...managerData });
        showToast('Manager added successfully', 'success');
      }
      
      // Update timestamp and save data
      updateTimestamp('managers');
      saveDataToStorage();
      
      closeForm('manager-form-popup');
      renderManagers();
      updateDashboardCounters();
    } catch (error) {
      console.error('Error saving manager:', error);
      showToast('Error saving manager. Please try again.', 'error');
    } finally {
      hideLoadingOverlay();
    }
  }
  
  function confirmDeleteManager(id) {
    showConfirmDialog(
      'Delete Manager',
      'Are you sure you want to delete this manager? This action cannot be undone.',
      function() {
        deleteManager(id);
      }
    );
  }
  
  function deleteManager(id) {
    showLoadingOverlay();
    
    try {
      sampleData.managers = sampleData.managers.filter(m => m.ID !== id);
      updateTimestamp('managers');
      saveDataToStorage();
      
      showToast('Manager deleted successfully', 'success');
      renderManagers();
      updateDashboardCounters();
    } catch (error) {
      console.error('Error deleting manager:', error);
      showToast('Error deleting manager. Please try again.', 'error');
    } finally {
      hideLoadingOverlay();
    }
  }
  
  // --- AGENT MANAGEMENT ---
  function renderAgents() {
    const tbody = document.getElementById('agent-table-body');
    tbody.innerHTML = '';
    
    // Get month filter value
    const monthFilter = document.getElementById('month-filter').value;
    
    // Filter agents by month if selected
    const filteredAgents = monthFilter 
      ? sampleData.agents.filter(agent => agent.Month === monthFilter)
      : sampleData.agents;
    
    // Update agent performance summary with filtered data
    updateAgentPerformanceSummary(filteredAgents, monthFilter);
    
    filteredAgents.forEach(agent => {
      const row = tbody.insertRow();
      const statusClass = agent.Status === 'Active' ? 'status-active' : 'status-inactive';
      
      // Determine missed rate class
      let missedRateClass = 'medium';
      if (agent.MissedRate < 30) {
        missedRateClass = 'high';
      } else if (agent.MissedRate > 50) {
        missedRateClass = 'low';
      }
      
      row.innerHTML = `
        <td>${agent.ID}</td>
        <td>${agent.Name}</td>
        <td>${agent.Month}</td>
        <td>${agent.TotalRings}</td>
        <td>${agent.Answered}</td>
        <td>${agent.Missed}</td>
        <td>${agent.AvgWaitTime}</td>
        <td>${agent.MaxWaitTime}</td>
        <td>${agent.AvgTalkTime}</td>
        <td>${agent.TotalTalkTime}</td>
        <td><span class="agent-performance-value ${missedRateClass}">${agent.MissedRate}%</span></td>
        <td>
          <button class="action-btn tooltip" onclick="openAgentForm(${agent.ID})" title="Edit">
            <i class="fas fa-edit"></i>
            <span class="tooltiptext">Edit Agent</span>
          </button>
          <button class="action-btn delete tooltip" onclick="confirmDeleteAgent(${agent.ID})" title="Delete">
            <i class="fas fa-trash"></i>
            <span class="tooltiptext">Delete Agent</span>
          </button>
        </td>
      `;
    });
    
    // Initialize search
    const searchInput = document.getElementById('agent-search');
    searchInput.addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase();
      const monthFilter = document.getElementById('month-filter').value;
      
      let filteredData = sampleData.agents;
      
      // Apply month filter if selected
      if (monthFilter) {
        filteredData = filteredData.filter(agent => agent.Month === monthFilter);
      }
      
      // Apply search term filter
      filteredData = filteredData.filter(agent => 
        agent.Name.toLowerCase().includes(searchTerm) ||
        agent.Phone.toLowerCase().includes(searchTerm) ||
        agent.Email.toLowerCase().includes(searchTerm) ||
        agent.Area.toLowerCase().includes(searchTerm) ||
        agent.TotalRings.toString().includes(searchTerm) ||
        agent.Answered.toString().includes(searchTerm) ||
        agent.Missed.toString().includes(searchTerm) ||
        agent.MissedRate.toString().includes(searchTerm)
      );
      
      tbody.innerHTML = '';
      filteredData.forEach(agent => {
        const row = tbody.insertRow();
        const statusClass = agent.Status === 'Active' ? 'status-active' : 'status-inactive';
        
        // Determine missed rate class
        let missedRateClass = 'medium';
        if (agent.MissedRate < 30) {
          missedRateClass = 'high';
        } else if (agent.MissedRate > 50) {
          missedRateClass = 'low';
        }
        
        row.innerHTML = `
          <td>${agent.ID}</td>
          <td>${agent.Name}</td>
          <td>${agent.Month}</td>
          <td>${agent.TotalRings}</td>
          <td>${agent.Answered}</td>
          <td>${agent.Missed}</td>
          <td>${agent.AvgWaitTime}</td>
          <td>${agent.MaxWaitTime}</td>
          <td>${agent.AvgTalkTime}</td>
          <td>${agent.TotalTalkTime}</td>
          <td><span class="agent-performance-value ${missedRateClass}">${agent.MissedRate}%</span></td>
          <td>
            <button class="action-btn tooltip" onclick="openAgentForm(${agent.ID})" title="Edit">
              <i class="fas fa-edit"></i>
              <span class="tooltiptext">Edit Agent</span>
            </button>
            <button class="action-btn delete tooltip" onclick="confirmDeleteAgent(${agent.ID})" title="Delete">
              <i class="fas fa-trash"></i>
              <span class="tooltiptext">Delete Agent</span>
            </button>
          </td>
        `;
      });
      
      // Update summary with filtered data
      updateAgentPerformanceSummary(filteredData, monthFilter);
    });
    
    // Initialize month filter
    const monthFilterSelect = document.getElementById('month-filter');
    monthFilterSelect.addEventListener('change', function() {
      if (this.value) {
        showConfirmDialog(
          'Apply Filter',
          `Are you sure you want to filter agents by ${this.value}?`,
          function() {
            renderAgents();
          },
          function() {
            // Reset filter if cancelled
            monthFilterSelect.value = '';
            renderAgents();
          }
        );
      } else {
        renderAgents();
      }
    });
  }
  
  function updateAgentPerformanceSummary(agents, monthFilter) {
    // Calculate totals for the provided agents
    let totalRings = 0;
    let totalAnswered = 0;
    let totalMissed = 0;
    let totalMissedRate = 0;
    
    agents.forEach(agent => {
      totalRings += agent.TotalRings;
      totalAnswered += agent.Answered;
      totalMissed += agent.Missed;
    });
    
    if (totalRings > 0) {
      totalMissedRate = (totalMissed / totalRings * 100).toFixed(1);
    }
    
    // Calculate average times
    let avgWaitTime = '00:00:00';
    let maxWaitTime = '00:00:00';
    let avgTalkTime = '00:00:00';
    let totalTalkTime = '00:00:00';
    
    // For simplicity, we'll just use the values from the first agent
    // In a real implementation, you would calculate proper averages
    if (agents.length > 0) {
      avgWaitTime = agents[0].AvgWaitTime;
      maxWaitTime = agents[0].MaxWaitTime;
      avgTalkTime = agents[0].AvgTalkTime;
      totalTalkTime = agents[0].TotalTalkTime;
    }
    
    // Update the DOM
    document.getElementById('agent-total-rings').textContent = totalRings.toLocaleString();
    document.getElementById('agent-answered').textContent = totalAnswered.toLocaleString();
    document.getElementById('agent-missed').textContent = totalMissed.toLocaleString();
    document.getElementById('agent-missed-rate').textContent = `${totalMissedRate}%`;
    document.getElementById('agent-avg-wait').textContent = avgWaitTime;
    document.getElementById('agent-max-wait').textContent = maxWaitTime;
    document.getElementById('agent-avg-talk').textContent = avgTalkTime;
    document.getElementById('agent-total-talk').textContent = totalTalkTime;
    
    // Update missed rate color
    const missedRateElement = document.getElementById('agent-missed-rate');
    missedRateElement.className = 'agent-performance-value';
    
    if (totalMissedRate < 30) {
      missedRateElement.classList.add('high');
    } else if (totalMissedRate > 50) {
      missedRateElement.classList.add('low');
    } else {
      missedRateElement.classList.add('medium');
    }
    
    // Update the period indicator
    const periodElement = document.getElementById('agent-summary-period');
    periodElement.textContent = monthFilter ? monthFilter : 'All Months';
  }
  
  function openAgentForm(id = null) {
    const formPopup = document.getElementById('agent-form-popup');
    formPopup.style.display = 'flex';
    
    // Reset form changes tracking
    formHasChanges['agent-form'] = false;
    
    if (id) {
      // Edit existing agent
      const agent = sampleData.agents.find(a => a.ID === id);
      if (agent) {
        document.getElementById('agent-form-title').textContent = 'Edit Agent';
        document.getElementById('agent-submit-btn').textContent = 'Update Agent';
        document.getElementById('agent-edit-id').value = agent.ID;
        document.getElementById('agent-delete-btn').style.display = 'inline-block';
        
        // Populate form fields
        document.getElementById('agent-name').value = agent.Name;
        document.getElementById('agent-phone').value = agent.Phone;
        document.getElementById('agent-email').value = agent.Email;
        document.getElementById('agent-area').value = agent.Area;
        document.getElementById('agent-commission').value = agent.Commission;
        document.getElementById('agent-join-date').value = formatDateForInput(agent.JoinDate);
        document.getElementById('agent-status').value = agent.Status;
        
        // Populate performance metrics
        document.getElementById('agent-month').value = agent.Month;
        document.getElementById('agent-total-rings').value = agent.TotalRings;
        document.getElementById('agent-answered').value = agent.Answered;
        document.getElementById('agent-missed').value = agent.Missed;
        document.getElementById('agent-avg-wait-time').value = agent.AvgWaitTime;
        document.getElementById('agent-max-wait-time').value = agent.MaxWaitTime;
        document.getElementById('agent-avg-talk-time').value = agent.AvgTalkTime;
        document.getElementById('agent-total-talk-time').value = agent.TotalTalkTime;
        document.getElementById('agent-missed-rate').value = agent.MissedRate;
      }
    } else {
      // Add new agent
      document.getElementById('agent-form-title').textContent = 'Add New Agent';
      document.getElementById('agent-submit-btn').textContent = 'Save Agent';
      document.getElementById('agent-edit-id').value = '';
      document.getElementById('agent-delete-btn').style.display = 'none';
      document.getElementById('agent-form').reset();
    }
    
    // Calculate missed rate automatically when rings or missed values change
    const totalRingsInput = document.getElementById('agent-total-rings');
    const missedInput = document.getElementById('agent-missed');
    const missedRateInput = document.getElementById('agent-missed-rate');
    
    function calculateMissedRate() {
      const totalRings = parseInt(totalRingsInput.value) || 0;
      const missed = parseInt(missedInput.value) || 0;
      
      if (totalRings > 0) {
        const rate = (missed / totalRings * 100).toFixed(2);
        missedRateInput.value = rate;
      } else {
        missedRateInput.value = '0';
      }
    }
    
    totalRingsInput.addEventListener('input', calculateMissedRate);
    missedInput.addEventListener('input', calculateMissedRate);
    
    // Track form changes
    trackFormChanges('agent-form');
  }
  
  function submitAgentForm(e) {
    e.preventDefault();
    
    // Validate form
    if (!validateForm('agent-form')) {
      showToast('Please fix the errors in the form', 'error');
      return;
    }
    
    showLoadingOverlay();
    
    const agentId = document.getElementById('agent-edit-id').value;
    const agentData = {
      Name: document.getElementById('agent-name').value,
      Phone: document.getElementById('agent-phone').value,
      Email: document.getElementById('agent-email').value,
      Area: document.getElementById('agent-area').value,
      Commission: parseFloat(document.getElementById('agent-commission').value) || 0,
      JoinDate: formatDateForStorage(document.getElementById('agent-join-date').value),
      Status: document.getElementById('agent-status').value,
      Month: document.getElementById('agent-month').value,
      TotalRings: parseInt(document.getElementById('agent-total-rings').value) || 0,
      Answered: parseInt(document.getElementById('agent-answered').value) || 0,
      Missed: parseInt(document.getElementById('agent-missed').value) || 0,
      AvgWaitTime: document.getElementById('agent-avg-wait-time').value,
      MaxWaitTime: document.getElementById('agent-max-wait-time').value,
      AvgTalkTime: document.getElementById('agent-avg-talk-time').value,
      TotalTalkTime: document.getElementById('agent-total-talk-time').value,
      MissedRate: parseFloat(document.getElementById('agent-missed-rate').value) || 0
    };
    
    try {
      if (agentId) {
        // Update existing agent
        const index = sampleData.agents.findIndex(a => a.ID == agentId);
        if (index !== -1) {
          sampleData.agents[index] = { ...sampleData.agents[index], ...agentData };
          showToast('Agent updated successfully', 'success');
        }
      } else {
        // Add new agent
        const newId = Math.max(...sampleData.agents.map(a => a.ID), 0) + 1;
        sampleData.agents.push({ ID: newId, ...agentData });
        showToast('Agent added successfully', 'success');
      }
      
      // Update timestamp and save data
      updateTimestamp('agents');
      saveDataToStorage();
      
      closeForm('agent-form-popup');
      renderAgents();
      updateDashboardCounters();
    } catch (error) {
      console.error('Error saving agent:', error);
      showToast('Error saving agent. Please try again.', 'error');
    } finally {
      hideLoadingOverlay();
    }
  }
  
  function confirmDeleteAgent(id) {
    showConfirmDialog(
      'Delete Agent',
      'Are you sure you want to delete this agent? This action cannot be undone.',
      function() {
        deleteAgent(id);
      }
    );
  }
  
  function deleteAgent(id) {
    showLoadingOverlay();
    
    try {
      sampleData.agents = sampleData.agents.filter(a => a.ID !== id);
      updateTimestamp('agents');
      saveDataToStorage();
      
      showToast('Agent deleted successfully', 'success');
      renderAgents();
      updateDashboardCounters();
    } catch (error) {
      console.error('Error deleting agent:', error);
      showToast('Error deleting agent. Please try again.', 'error');
    } finally {
      hideLoadingOverlay();
    }
  }
  
  // --- MONTHLY SALES MANAGEMENT ---
  function renderMonthlySales() {
    const tbody = document.getElementById('monthly-sales-table-body');
    tbody.innerHTML = '';
    
    // Get year and month filter values
    const yearFilter = document.getElementById('year-filter').value;
    const monthFilter = document.getElementById('sales-month-filter').value;
    
    // Filter sales by year and month if selected
    let filteredSales = sampleData.monthlySales;
    
    if (yearFilter) {
      filteredSales = filteredSales.filter(sale => sale.Year.toString() === yearFilter);
    }
    
    if (monthFilter) {
      filteredSales = filteredSales.filter(sale => sale.Month.toString() === monthFilter);
    }
    
    // Update monthly sales summary cards
    updateMonthlySalesSummary(filteredSales);
    
    filteredSales.forEach(sale => {
      const row = tbody.insertRow();
      
      // Determine percentage class
      let percentageClass = 'medium';
      if (sale.Percentage >= 10) {
        percentageClass = 'high';
      } else if (sale.Percentage < 8) {
        percentageClass = 'low';
      }
      
      // Convert month number to name
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const monthName = monthNames[sale.Month - 1] || sale.Month;
      
      row.innerHTML = `
        <td>${sale.ID}</td>
        <td>${sale.Branch}</td>
        <td>${sale.Year}</td>
        <td>${monthName}</td>
        <td>${sale.DeliveryCount}</td>
        <td><span class="agent-performance-value ${percentageClass}">${sale.Percentage}%</span></td>
        <td>AED ${sale.Amount.toLocaleString()}</td>
        <td>
          <button class="action-btn tooltip" onclick="openMonthlySalesForm(${sale.ID})" title="Edit">
            <i class="fas fa-edit"></i>
            <span class="tooltiptext">Edit Sales</span>
          </button>
          <button class="action-btn delete tooltip" onclick="confirmDeleteMonthlySales(${sale.ID})" title="Delete">
            <i class="fas fa-trash"></i>
            <span class="tooltiptext">Delete Sales</span>
          </button>
        </td>
      `;
    });
    
    // Initialize search
    const searchInput = document.getElementById('monthly-sales-search');
    searchInput.addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase();
      const yearFilter = document.getElementById('year-filter').value;
      const monthFilter = document.getElementById('sales-month-filter').value;
      
      let filteredData = sampleData.monthlySales;
      
      // Apply year filter if selected
      if (yearFilter) {
        filteredData = filteredData.filter(sale => sale.Year.toString() === yearFilter);
      }
      
      // Apply month filter if selected
      if (monthFilter) {
        filteredData = filteredData.filter(sale => sale.Month.toString() === monthFilter);
      }
      
      // Apply search term filter
      filteredData = filteredData.filter(sale => 
        sale.Branch.toLowerCase().includes(searchTerm) ||
        sale.Month.toString().includes(searchTerm) ||
        sale.DeliveryCount.toString().includes(searchTerm) ||
        sale.Percentage.toString().includes(searchTerm) ||
        sale.Amount.toString().includes(searchTerm)
      );
      
      tbody.innerHTML = '';
      filteredData.forEach(sale => {
        const row = tbody.insertRow();
        
        // Determine percentage class
        let percentageClass = 'medium';
        if (sale.Percentage >= 10) {
          percentageClass = 'high';
        } else if (sale.Percentage < 8) {
          percentageClass = 'low';
        }
        
        // Convert month number to name
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const monthName = monthNames[sale.Month - 1] || sale.Month;
        
        row.innerHTML = `
          <td>${sale.ID}</td>
          <td>${sale.Branch}</td>
          <td>${sale.Year}</td>
          <td>${monthName}</td>
          <td>${sale.DeliveryCount}</td>
          <td><span class="agent-performance-value ${percentageClass}">${sale.Percentage}%</span></td>
          <td>AED ${sale.Amount.toLocaleString()}</td>
          <td>
            <button class="action-btn tooltip" onclick="openMonthlySalesForm(${sale.ID})" title="Edit">
              <i class="fas fa-edit"></i>
              <span class="tooltiptext">Edit Sales</span>
            </button>
            <button class="action-btn delete tooltip" onclick="confirmDeleteMonthlySales(${sale.ID})" title="Delete">
              <i class="fas fa-trash"></i>
              <span class="tooltiptext">Delete Sales</span>
            </button>
          </td>
        `;
      });
    });
    
    // Initialize year filter
    const yearFilterSelect = document.getElementById('year-filter');
    yearFilterSelect.addEventListener('change', function() {
      if (this.value || document.getElementById('sales-month-filter').value) {
        showConfirmDialog(
          'Apply Filter',
          'Are you sure you want to apply these filters?',
          function() {
            renderMonthlySales();
          },
          function() {
            // Reset filters if cancelled
            yearFilterSelect.value = '';
            document.getElementById('sales-month-filter').value = '';
            renderMonthlySales();
          }
        );
      } else {
        renderMonthlySales();
      }
    });
    
    // Initialize month filter
    const monthFilterSelect = document.getElementById('sales-month-filter');
    monthFilterSelect.addEventListener('change', function() {
      if (this.value || document.getElementById('year-filter').value) {
        showConfirmDialog(
          'Apply Filter',
          'Are you sure you want to apply these filters?',
          function() {
            renderMonthlySales();
          },
          function() {
            // Reset filters if cancelled
            monthFilterSelect.value = '';
            document.getElementById('year-filter').value = '';
            renderMonthlySales();
          }
        );
      } else {
        renderMonthlySales();
      }
    });
  }
  
  function updateMonthlySalesSummary(salesData) {
    const summaryContainer = document.getElementById('monthly-sales-summary');
    summaryContainer.innerHTML = '';
    
    // Group sales by month
    const monthlyData = {};
    
    salesData.forEach(sale => {
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const monthName = monthNames[sale.Month - 1] || sale.Month;
      
      if (!monthlyData[monthName]) {
        monthlyData[monthName] = {
          month: monthName,
          totalDeliveryCount: 0,
          avgPercentage: 0,
          totalAmount: 0,
          count: 0
        };
      }
      
      monthlyData[monthName].totalDeliveryCount += sale.DeliveryCount;
      monthlyData[monthName].avgPercentage += sale.Percentage;
      monthlyData[monthName].totalAmount += sale.Amount;
      monthlyData[monthName].count += 1;
    });
    
    // Calculate average percentage
    Object.keys(monthlyData).forEach(month => {
      monthlyData[month].avgPercentage = monthlyData[month].avgPercentage / monthlyData[month].count;
    });
    
    // Create summary cards
    Object.values(monthlyData).forEach(data => {
      const card = document.createElement('div');
      card.className = 'monthly-sales-card';
      
      // Determine percentage class
      let percentageClass = 'medium';
      if (data.avgPercentage >= 10) {
        percentageClass = 'high';
      } else if (data.avgPercentage < 8) {
        percentageClass = 'low';
      }
      
      card.innerHTML = `
        <div class="month">${data.month}</div>
        <div class="percentage ${percentageClass}">${data.avgPercentage.toFixed(1)}%</div>
        <div class="delivery-count">${data.totalDeliveryCount} deliveries</div>
        <div class="amount">AED ${data.totalAmount.toLocaleString()}</div>
      `;
      
      summaryContainer.appendChild(card);
    });
  }
  
  function openMonthlySalesForm(id = null) {
    const formPopup = document.getElementById('monthly-sales-form-popup');
    formPopup.style.display = 'flex';
    
    // Reset form changes tracking
    formHasChanges['monthly-sales-form'] = false;
    
    // Populate branch dropdown
    const branchSelect = document.getElementById('monthly-sales-branch');
    branchSelect.innerHTML = '<option value="">Select Branch</option>';
    sampleData.branches.forEach(branch => {
      const option = document.createElement('option');
      option.value = branch['Branch Name'];
      option.textContent = branch['Branch Name'];
      branchSelect.appendChild(option);
    });
    
    // Populate year dropdown
    const yearSelect = document.getElementById('monthly-sales-year');
    yearSelect.innerHTML = '';
    const currentYear = new Date().getFullYear();
    for (let year = currentYear - 2; year <= currentYear + 2; year++) {
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year;
      yearSelect.appendChild(option);
    }
    
    // Populate month dropdown
    const monthSelect = document.getElementById('monthly-sales-month');
    monthSelect.innerHTML = '';
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    months.forEach((month, index) => {
      const option = document.createElement('option');
      option.value = index + 1; // Store as number (1-12)
      option.textContent = month;
      monthSelect.appendChild(option);
    });
    
    if (id) {
      // Edit existing monthly sales
      const sale = sampleData.monthlySales.find(s => s.ID === id);
      if (sale) {
        document.getElementById('monthly-sales-form-title').textContent = 'Edit Monthly Sales';
        document.getElementById('monthly-sales-submit-btn').textContent = 'Update Monthly Sales';
        document.getElementById('monthly-sales-edit-id').value = sale.ID;
        document.getElementById('monthly-sales-delete-btn').style.display = 'inline-block';
        
        // Populate form fields
        document.getElementById('monthly-sales-branch').value = sale.Branch;
        document.getElementById('monthly-sales-year').value = sale.Year;
        document.getElementById('monthly-sales-month').value = sale.Month;
        document.getElementById('monthly-sales-delivery-count').value = sale.DeliveryCount;
        document.getElementById('monthly-sales-percentage').value = sale.Percentage;
        document.getElementById('monthly-sales-amount').value = sale.Amount;
      }
    } else {
      // Add new monthly sales
      document.getElementById('monthly-sales-form-title').textContent = 'Add Monthly Sales';
      document.getElementById('monthly-sales-submit-btn').textContent = 'Save Monthly Sales';
      document.getElementById('monthly-sales-edit-id').value = '';
      document.getElementById('monthly-sales-delete-btn').style.display = 'none';
      document.getElementById('monthly-sales-form').reset();
      
      // Set default values
      document.getElementById('monthly-sales-year').value = currentYear;
      document.getElementById('monthly-sales-month').value = new Date().getMonth() + 1;
    }
    
    // Track form changes
    trackFormChanges('monthly-sales-form');
  }
  
  function submitMonthlySalesForm(e) {
    e.preventDefault();
    
    // Validate form
    if (!validateForm('monthly-sales-form')) {
      showToast('Please fix the errors in the form', 'error');
      return;
    }
    
    showLoadingOverlay();
    
    const salesId = document.getElementById('monthly-sales-edit-id').value;
    const salesData = {
      Branch: document.getElementById('monthly-sales-branch').value,
      Year: parseInt(document.getElementById('monthly-sales-year').value),
      Month: parseInt(document.getElementById('monthly-sales-month').value),
      DeliveryCount: parseInt(document.getElementById('monthly-sales-delivery-count').value) || 0,
      Percentage: parseFloat(document.getElementById('monthly-sales-percentage').value) || 0,
      Amount: parseFloat(document.getElementById('monthly-sales-amount').value) || 0
    };
    
    try {
      if (salesId) {
        // Update existing monthly sales
        const index = sampleData.monthlySales.findIndex(s => s.ID == salesId);
        if (index !== -1) {
          sampleData.monthlySales[index] = { ...sampleData.monthlySales[index], ...salesData };
          showToast('Monthly sales updated successfully', 'success');
        }
      } else {
        // Add new monthly sales
        const newId = Math.max(...sampleData.monthlySales.map(s => s.ID), 0) + 1;
        sampleData.monthlySales.push({ ID: newId, ...salesData });
        showToast('Monthly sales added successfully', 'success');
      }
      
      // Update timestamp and save data
      updateTimestamp('sales');
      saveDataToStorage();
      
      closeForm('monthly-sales-form-popup');
      renderMonthlySales();
      updateDashboardCounters();
    } catch (error) {
      console.error('Error saving monthly sales:', error);
      showToast('Error saving monthly sales. Please try again.', 'error');
    } finally {
      hideLoadingOverlay();
    }
  }
  
  function confirmDeleteMonthlySales(id) {
    showConfirmDialog(
      'Delete Monthly Sales',
      'Are you sure you want to delete this monthly sales record? This action cannot be undone.',
      function() {
        deleteMonthlySales(id);
      }
    );
  }
  
  function deleteMonthlySales(id) {
    showLoadingOverlay();
    
    try {
      sampleData.monthlySales = sampleData.monthlySales.filter(s => s.ID !== id);
      updateTimestamp('sales');
      saveDataToStorage();
      
      showToast('Monthly sales deleted successfully', 'success');
      renderMonthlySales();
      updateDashboardCounters();
    } catch (error) {
      console.error('Error deleting monthly sales:', error);
      showToast('Error deleting monthly sales. Please try again.', 'error');
    } finally {
      hideLoadingOverlay();
    }
  }
  
  // --- EXPORT FUNCTIONS ---
  function exportData(dataType) {
    showLoadingOverlay();
    
    try {
      let data = [];
      let headers = [];
      let filename = '';
      
      switch (dataType) {
        case 'branches':
          data = sampleData.branches;
          headers = ['ID', 'Branch Name', 'City', 'Area', 'Manager', 'Delivery Status'];
          filename = 'branches_export';
          break;
        case 'drivers':
          data = sampleData.drivers;
          headers = ['ID', 'Name', 'Mobile Number', 'Bike Number', 'Outlet', 'Plate Number', 'License Expiry', 'Status'];
          filename = 'drivers_export';
          break;
        case 'managers':
          data = sampleData.managers;
          headers = ['ID', 'Name', 'Phone', 'Email', 'Branch', 'Status'];
          filename = 'managers_export';
          break;
        case 'agents':
          data = sampleData.agents;
          headers = ['ID', 'Name', 'Phone', 'Email', 'Area', 'Commission', 'Status', 'Month', 'Total Rings', 'Answered', 'Missed', 'Avg. Wait Time', 'Max Wait Time', 'Avg. Talk Time', 'Total Talk Time', 'Missed Rate'];
          filename = 'agents_export';
          break;
        case 'monthly-sales':
          data = sampleData.monthlySales;
          headers = ['ID', 'Branch', 'Year', 'Month', 'Delivery Count', 'Percentage', 'Amount'];
          filename = 'monthly_sales_export';
          break;
        default:
          hideLoadingOverlay();
          return;
      }
      
      // Create CSV content
      let csvContent = headers.join(',') + '\n';
      
      data.forEach(item => {
        const row = headers.map(header => {
          // Handle nested objects and special formatting
          let value = item[header.replace(/\s/g, '')] || '';
          
          // Format dates
          if (header.includes('Date') || header.includes('Expiry')) {
            value = formatDateForStorage(value);
          }
          
          // Escape commas and quotes
          if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
            value = '"' + value.replace(/"/g, '""') + '"';
          }
          
          return value;
        });
        
        csvContent += row.join(',') + '\n';
      });
      
      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', filename + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast(`${filename} exported successfully`, 'success');
    } catch (error) {
      console.error('Error exporting data:', error);
      showToast('Error exporting data. Please try again.', 'error');
    } finally {
      hideLoadingOverlay();
    }
  }
  
  function exportAllData() {
    showLoadingOverlay();
    
    try {
      // Create a combined export of all data
      const allData = {
        branches: sampleData.branches,
        drivers: sampleData.drivers,
        managers: sampleData.managers,
        agents: sampleData.agents,
        monthlySales: sampleData.monthlySales
      };
      
      // Convert to JSON and download
      const jsonStr = JSON.stringify(allData, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'crispy_chicken_data_export.json');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('All data exported successfully', 'success');
    } catch (error) {
      console.error('Error exporting all data:', error);
      showToast('Error exporting data. Please try again.', 'error');
    } finally {
      hideLoadingOverlay();
    }
  }
  
  // --- UTILITY FUNCTIONS ---
  function closeForm(formId) {
    document.getElementById(formId).style.display = 'none';
    formHasChanges[formId.replace('-popup', '')] = false;
  }
  
  function confirmCloseForm(formId) {
    const formName = formId.replace('-popup', '');
    
    if (formHasChanges[formName]) {
      showConfirmDialog(
        'Unsaved Changes',
        'You have unsaved changes. Are you sure you want to close this form?',
        function() {
          closeForm(formId);
        }
      );
    } else {
      closeForm(formId);
    }
  }
  
  function clearForm(formId) {
    showConfirmDialog(
      'Clear Form',
      'Are you sure you want to clear all form data?',
      function() {
        document.getElementById(formId).reset();
        formHasChanges[formId] = false;
      }
    );
  }
  
  function trackFormChanges(formId) {
    const form = document.getElementById(formId);
    const inputs = form.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
      input.addEventListener('input', function() {
        formHasChanges[formId] = true;
      });
      
      input.addEventListener('change', function() {
        formHasChanges[formId] = true;
      });
    });
  }
  
  function validateForm(formId) {
    const form = document.getElementById(formId);
    const inputs = form.querySelectorAll('[required]');
    let isValid = true;
    
    inputs.forEach(input => {
      const formGroup = input.closest('.form-group');
      
      if (!input.value.trim()) {
        formGroup.classList.add('error');
        isValid = false;
      } else {
        formGroup.classList.remove('error');
      }
      
      // Additional validation for specific input types
      if (input.type === 'email' && input.value) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(input.value)) {
          formGroup.classList.add('error');
          isValid = false;
        }
      }
      
      if (input.type === 'number' && input.value) {
        if (isNaN(input.value) || parseFloat(input.value) < 0) {
          formGroup.classList.add('error');
          isValid = false;
        }
      }
    });
    
    return isValid;
  }
  
  function formatDateForInput(dateStr) {
    if (!dateStr) return '';
    
    // Convert DD/MM/YYYY to YYYY-MM-DD for input fields
    const parts = dateStr.split('/');
    if (parts.length === 3) {
      return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }
    
    // If already in YYYY-MM-DD format, return as is
    return dateStr;
  }
  
  function formatDateForStorage(dateStr) {
    if (!dateStr) return '';
    
    // Convert YYYY-MM-DD to DD/MM/YYYY for storage
    const parts = dateStr.split('-');
    if (parts.length === 3) {
      return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }
    
    // If already in DD/MM/YYYY format, return as is
    return dateStr;
  }
  
  // --- NOTIFICATION SYSTEM ---
  function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container');
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = '';
    switch (type) {
      case 'success':
        icon = 'fa-check-circle';
        break;
      case 'error':
        icon = 'fa-exclamation-circle';
        break;
      case 'warning':
        icon = 'fa-exclamation-triangle';
        break;
      case 'info':
      default:
        icon = 'fa-info-circle';
        break;
    }
    
    toast.innerHTML = `
      <i class="fas ${icon} toast-icon"></i>
      <span>${message}</span>
      <button class="toast-close">&times;</button>
      <div class="toast-progress"></div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Add event listener to close button
    toast.querySelector('.toast-close').addEventListener('click', function() {
      toast.classList.add('hiding');
      setTimeout(() => {
        toastContainer.removeChild(toast);
      }, 300);
    });
    
    // Auto remove after 5 seconds
    setTimeout(() => {
      if (toast.parentNode) {
        toast.classList.add('hiding');
        setTimeout(() => {
          if (toast.parentNode) {
            toastContainer.removeChild(toast);
          }
        }, 300);
      }
    }, 5000);
  }
  
  // --- LOADING OVERLAY ---
  function showLoadingOverlay() {
    document.getElementById('loading-overlay').classList.add('active');
  }
  
  function hideLoadingOverlay() {
    document.getElementById('loading-overlay').classList.remove('active');
  }
  
  // --- CONFIRMATION DIALOG ---
  function showConfirmDialog(title, message, onConfirm, onCancel) {
    const dialog = document.getElementById('confirm-dialog');
    const titleElement = document.getElementById('confirm-title');
    const messageElement = document.getElementById('confirm-message');
    const okButton = document.getElementById('confirm-ok');
    const cancelButton = document.getElementById('confirm-cancel');
    
    titleElement.textContent = title;
    messageElement.textContent = message;
    
    dialog.classList.add('active');
    
    // Remove previous event listeners
    const newOkButton = okButton.cloneNode(true);
    const newCancelButton = cancelButton.cloneNode(true);
    okButton.parentNode.replaceChild(newOkButton, okButton);
    cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);
    
    // Add new event listeners
    newOkButton.addEventListener('click', function() {
      dialog.classList.remove('active');
      if (onConfirm) onConfirm();
    });
    
    newCancelButton.addEventListener('click', function() {
      dialog.classList.remove('active');
      if (onCancel) onCancel();
    });
  }
  
  // --- KEYBOARD SHORTCUTS ---
  function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
      // Ctrl+S: Save form
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        const activeForm = document.querySelector('.form-popup[style*="flex"]');
        if (activeForm) {
          const formId = activeForm.id.replace('-popup', '');
          const submitButton = document.getElementById(`${formId}-submit-btn`);
          if (submitButton) {
            submitButton.click();
          }
        }
      }
      
      // Esc: Close form
      if (e.key === 'Escape') {
        const activeForm = document.querySelector('.form-popup[style*="flex"]');
        if (activeForm) {
          confirmCloseForm(activeForm.id);
        }
        
        const activeDialog = document.querySelector('.confirm-dialog.active');
        if (activeDialog) {
          document.getElementById('confirm-cancel').click();
        }
        
        const activeHelp = document.querySelector('.shortcuts-help.active');
        if (activeHelp) {
          activeHelp.classList.remove('active');
        }
      }
      
      // Ctrl+E: Export data
      if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        if (activeSection === 'dashboard') {
          exportAllData();
        } else {
          exportData(activeSection);
        }
      }
      
      // Ctrl+?: Show keyboard shortcuts help
      if (e.ctrlKey && e.key === '?') {
        e.preventDefault();
        const helpPanel = document.getElementById('shortcuts-help');
        helpPanel.classList.toggle('active');
      }
    });
  }
  
  // --- FORM SUBMISSION HANDLERS ---
  document.getElementById('branch-form').addEventListener('submit', submitBranchForm);
  document.getElementById('driver-form').addEventListener('submit', submitDriverForm);
  document.getElementById('manager-form').addEventListener('submit', submitManagerForm);
  document.getElementById('agent-form').addEventListener('submit', submitAgentForm);
  document.getElementById('monthly-sales-form').addEventListener('submit', submitMonthlySalesForm);
</script>
</body>
</html>
