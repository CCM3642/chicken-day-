<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crispy Chicken - Compensation Tracking System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #e63946;
            --secondary-color: #f1faee;
            --accent-color: #a8dadc;
            --dark-color: #1d3557;
            --light-color: #f8f9fa;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: bold;
            color: white !important;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card {
            border-left: 5px solid var(--primary-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #d62828;
            border-color: #d62828;
        }
        
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .filter-section {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        
        .status-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .status-open {
            background-color: #ffc107;
            color: #212529;
        }
        
        .status-pending {
            background-color: #17a2b8;
            color: white;
        }
        
        .status-approved {
            background-color: #28a745;
            color: white;
        }
        
        .status-rejected {
            background-color: #dc3545;
            color: white;
        }
        
        .status-closed {
            background-color: #6c757d;
            color: white;
        }
        
        .logo {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        .footer {
            background-color: var(--dark-color);
            color: white;
            padding: 20px 0;
            margin-top: 40px;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        .custom-toast {
            min-width: 300px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        
        .fade-in {
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .chart-container {
                height: 250px;
            }
            
            .stat-card {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <span class="logo">üçó</span> Crispy Chicken - Compensation Tracking System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="dataCount">Total Cases: 0</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="lastUpdated">Last Updated: Never</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="newCase-tab" data-bs-toggle="tab" data-bs-target="#newCase" type="button" role="tab">
                    <i class="bi bi-plus-circle"></i> New Case
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cases-tab" data-bs-toggle="tab" data-bs-target="#cases" type="button" role="tab">
                    <i class="bi bi-list-ul"></i> All Cases
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
                    <i class="bi bi-file-earmark-bar-graph"></i> Reports
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="card stat-card fade-in">
                            <div class="card-body">
                                <h5 class="card-title">Total Cases (Month)</h5>
                                <h2 class="text-primary" id="totalCasesMonth">0</h2>
                                <small class="text-muted">This month</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card fade-in">
                            <div class="card-body">
                                <h5 class="card-title">Total Compensation</h5>
                                <h2 class="text-success" id="totalCompensation">AED 0</h2>
                                <small class="text-muted">All time</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card fade-in">
                            <div class="card-body">
                                <h5 class="card-title">Open Cases</h5>
                                <h2 class="text-warning" id="openCases">0</h2>
                                <small class="text-muted">Pending resolution</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card fade-in">
                            <div class="card-body">
                                <h5 class="card-title">Resolution Rate</h5>
                                <h2 class="text-info" id="resolutionRate">0%</h2>
                                <small class="text-muted">Last 30 days</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5>Cases by Platform</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="platformChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5>Cases by Branch</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="branchChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5>Status Breakdown</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5>Top Issue Types</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="issueTypeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5>Agent Performance</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Agent Name</th>
                                                <th>Cases Handled</th>
                                                <th>Resolution Rate</th>
                                                <th>Avg. Resolution Time</th>
                                            </tr>
                                        </thead>
                                        <tbody id="agentPerformanceTable">
                                            <tr>
                                                <td colspan="4" class="text-center">No data available</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Case Tab -->
            <div class="tab-pane fade" id="newCase" role="tabpanel">
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Register New Compensation Case</h5>
                    </div>
                    <div class="card-body">
                        <form id="newCaseForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="caseId" class="form-label">Case ID</label>
                                    <input type="text" class="form-control" id="caseId" readonly>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="date" class="form-label">Date of Incident</label>
                                    <input type="date" class="form-control" id="date" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="platform" class="form-label">Platform</label>
                                    <select class="form-select" id="platform" required>
                                        <option value="">Select Platform</option>
                                        <option value="Noon">Noon</option>
                                        <option value="Careem">Careem</option>
                                        <option value="Smile">Smile</option>
                                        <option value="Deliveroo">Deliveroo</option>
                                        <option value="Keita">Keita</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="branch" class="form-label">Branch</label>
                                    <select class="form-select" id="branch" required>
                                        <option value="">Select Branch</option>
                                        <option value="Hamdan">Hamdan</option>
                                        <option value="Khaldia">Khaldia</option>
                                        <option value="Shabiya 11">Shabiya 11</option>
                                        <option value="Muroor">Muroor</option>
                                        <option value="Electra">Electra</option>
                                        <option value="Barsha">Barsha</option>
                                        <option value="Satwa">Satwa</option>
                                        <option value="New Branch">New Branch</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="orderNumber" class="form-label">Order Number</label>
                                    <input type="text" class="form-control" id="orderNumber" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="customerName" class="form-label">Customer Name / Number</label>
                                    <input type="text" class="form-control" id="customerName" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="issueType" class="form-label">Issue Type</label>
                                    <select class="form-select" id="issueType" required>
                                        <option value="">Select Issue Type</option>
                                        <option value="Missing Item">Missing Item</option>
                                        <option value="Late Delivery">Late Delivery</option>
                                        <option value="Wrong Order">Wrong Order</option>
                                        <option value="Refund Request">Refund Request</option>
                                        <option value="Double Charge">Double Charge</option>
                                        <option value="Food Quality">Food Quality</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="responsibleParty" class="form-label">Responsible Party</label>
                                    <select class="form-select" id="responsibleParty" required>
                                        <option value="">Select Responsible Party</option>
                                        <option value="Platform">Platform</option>
                                        <option value="Restaurant">Restaurant</option>
                                        <option value="Driver">Driver</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="orderValue" class="form-label">Order Value (AED)</label>
                                    <input type="number" class="form-control" id="orderValue" min="0" step="0.01" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="compensationValue" class="form-label">Compensation Value (AED)</label>
                                    <input type="number" class="form-control" id="compensationValue" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="status" class="form-label">Status</label>
                                    <select class="form-select" id="status" required>
                                        <option value="Open">Open</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Approved">Approved</option>
                                        <option value="Rejected">Rejected</option>
                                        <option value="Closed">Closed</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="agentName" class="form-label">Agent Name</label>
                                    <input type="text" class="form-control" id="agentName" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="actionTaken" class="form-label">Action Taken</label>
                                    <textarea class="form-control" id="actionTaken" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="remarks" class="form-label">Remarks / Notes</label>
                                    <textarea class="form-control" id="remarks" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="supportingFile" class="form-label">Supporting File / Screenshot</label>
                                    <input type="text" class="form-control" id="supportingFile" placeholder="Enter file path or URL">
                                </div>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="reset" class="btn btn-secondary">Clear Form</button>
                                <button type="submit" class="btn btn-primary">Save Case</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- All Cases Tab -->
            <div class="tab-pane fade" id="cases" role="tabpanel">
                <div class="filter-section mt-4">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="filterPlatform" class="form-label">Filter by Platform</label>
                            <select class="form-select" id="filterPlatform">
                                <option value="">All Platforms</option>
                                <option value="Noon">Noon</option>
                                <option value="Careem">Careem</option>
                                <option value="Smile">Smile</option>
                                <option value="Deliveroo">Deliveroo</option>
                                <option value="Keita">Keita</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterBranch" class="form-label">Filter by Branch</label>
                            <select class="form-select" id="filterBranch">
                                <option value="">All Branches</option>
                                <option value="Hamdan">Hamdan</option>
                                <option value="Khaldia">Khaldia</option>
                                <option value="Shabiya 11">Shabiya 11</option>
                                <option value="Muroor">Muroor</option>
                                <option value="Electra">Electra</option>
                                <option value="Barsha">Barsha</option>
                                <option value="Satwa">Satwa</option>
                                <option value="New Branch">New Branch</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterStatus" class="form-label">Filter by Status</label>
                            <select class="form-select" id="filterStatus">
                                <option value="">All Statuses</option>
                                <option value="Open">Open</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="searchInput" class="form-label">Search</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search by case ID, order number, customer...">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="dateFrom" class="form-label">Date From</label>
                            <input type="date" class="form-control" id="dateFrom">
                        </div>
                        <div class="col-md-6">
                            <label for="dateTo" class="form-label">Date To</label>
                            <input type="date" class="form-control" id="dateTo">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button class="btn btn-primary" id="applyFilters">Apply Filters</button>
                            <button class="btn btn-secondary" id="resetFilters">Reset Filters</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>All Compensation Cases</h5>
                        <span id="casesCount" class="badge bg-primary">0 cases</span>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Case ID</th>
                                        <th>Date</th>
                                        <th>Platform</th>
                                        <th>Branch</th>
                                        <th>Order #</th>
                                        <th>Customer</th>
                                        <th>Issue Type</th>
                                        <th>Compensation</th>
                                        <th>Status</th>
                                        <th>Agent</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="casesTableBody">
                                    <tr>
                                        <td colspan="11" class="text-center">No cases found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div class="tab-pane fade" id="reports" role="tabpanel">
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Generate Reports</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="reportType" class="form-label">Report Type</label>
                                <select class="form-select" id="reportType">
                                    <option value="summary">Summary Report</option>
                                    <option value="detailed">Detailed Report</option>
                                    <option value="platform">Platform Performance</option>
                                    <option value="branch">Branch Performance</option>
                                    <option value="agent">Agent Performance</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="reportPeriod" class="form-label">Report Period</label>
                                <select class="form-select" id="reportPeriod">
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="year">This Year</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3" id="customDateRange" style="display: none;">
                            <div class="col-md-6">
                                <label for="reportDateFrom" class="form-label">From Date</label>
                                <input type="date" class="form-control" id="reportDateFrom">
                            </div>
                            <div class="col-md-6">
                                <label for="reportDateTo" class="form-label">To Date</label>
                                <input type="date" class="form-control" id="reportDateTo">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button class="btn btn-primary" id="generateReport">Generate Report</button>
                                <button class="btn btn-success" id="exportExcel">Export to Excel</button>
                                <button class="btn btn-info" id="exportPDF">Export to PDF</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4" id="reportPreview" style="display: none;">
                    <div class="card-header">
                        <h5>Report Preview</h5>
                    </div>
                    <div class="card-body">
                        <div id="reportContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Case Details Modal -->
    <div class="modal fade" id="caseDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Case Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="caseDetailsContent">
                    <!-- Case details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="editCaseBtn">Edit Case</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Case Modal -->
    <div class="modal fade" id="editCaseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Case</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCaseForm">
                        <!-- Edit form fields will be populated here -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveChangesBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Crispy Chicken Compensation Tracking System</h5>
                    <p>Managing compensation cases across all platforms and branches.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>&copy; 2023 Crispy Chicken. All rights reserved.</p>
                    <p>Version 1.0.0 | Last Updated: <span id="footerLastUpdated">Never</span></p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize data storage
        let compensationCases = JSON.parse(localStorage.getItem('compensationCases')) || [];
        let currentEditingCaseId = null;
        let charts = {
            platform: null,
            branch: null,
            status: null,
            issueType: null
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            document.getElementById('date').valueAsDate = new Date();
            
            // Generate initial case ID
            generateCaseId();
            
            // Load data and update UI
            loadCases();
            updateDashboard();
            updateLastUpdated();
            
            // Set up event listeners
            setupEventListeners();
            
            // Add some sample data if no data exists
            if (compensationCases.length === 0) {
                addSampleData();
            }
        });

        // Add sample data for testing
        function addSampleData() {
            const sampleCases = [
                {
                    id: 'CC-20231201-001',
                    date: '2023-12-01',
                    platform: 'Noon',
                    branch: 'Hamdan',
                    orderNumber: 'ORD123456',
                    customerName: 'John Doe',
                    issueType: 'Missing Item',
                    orderValue: 85.50,
                    compensationValue: 20.00,
                    responsibleParty: 'Restaurant',
                    status: 'Closed',
                    actionTaken: 'Refund processed via platform',
                    agentName: 'Agent A',
                    dateClosed: '2023-12-02T10:30:00Z',
                    supportingFile: '',
                    remarks: 'Customer satisfied with resolution',
                    createdAt: '2023-12-01T14:20:00Z'
                },
                {
                    id: 'CC-20231201-002',
                    date: '2023-12-01',
                    platform: 'Careem',
                    branch: 'Khaldia',
                    orderNumber: 'ORD789012',
                    customerName: 'Jane Smith',
                    issueType: 'Late Delivery',
                    orderValue: 120.00,
                    compensationValue: 30.00,
                    responsibleParty: 'Driver',
                    status: 'Open',
                    actionTaken: 'Contacted driver for explanation',
                    agentName: 'Agent B',
                    dateClosed: null,
                    supportingFile: '',
                    remarks: 'Waiting for customer feedback',
                    createdAt: '2023-12-01T16:45:00Z'
                },
                {
                    id: 'CC-20231202-003',
                    date: '2023-12-02',
                    platform: 'Deliveroo',
                    branch: 'Muroor',
                    orderNumber: 'ORD345678',
                    customerName: 'Mike Johnson',
                    issueType: 'Wrong Order',
                    orderValue: 95.00,
                    compensationValue: 25.00,
                    responsibleParty: 'Restaurant',
                    status: 'Pending',
                    actionTaken: 'Resending correct order',
                    agentName: 'Agent A',
                    dateClosed: null,
                    supportingFile: '',
                    remarks: 'Customer notified about replacement',
                    createdAt: '2023-12-02T11:30:00Z'
                }
            ];
            
            compensationCases = sampleCases;
            localStorage.setItem('compensationCases', JSON.stringify(compensationCases));
            loadCases();
            updateDashboard();
        }

        // Generate unique case ID
        function generateCaseId() {
            const date = new Date();
            const timestamp = date.getTime();
            const random = Math.floor(Math.random() * 1000);
            const caseId = `CC-${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}-${String(random).padStart(3, '0')}`;
            document.getElementById('caseId').value = caseId;
        }

        // Setup event listeners
        function setupEventListeners() {
            // New case form submission
            document.getElementById('newCaseForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveNewCase();
            });
            
            // Apply filters
            document.getElementById('applyFilters').addEventListener('click', function() {
                applyFilters();
            });
            
            // Reset filters
            document.getElementById('resetFilters').addEventListener('click', function() {
                resetFilters();
            });
            
            // Report period change
            document.getElementById('reportPeriod').addEventListener('change', function() {
                if (this.value === 'custom') {
                    document.getElementById('customDateRange').style.display = 'block';
                } else {
                    document.getElementById('customDateRange').style.display = 'none';
                }
            });
            
            // Generate report
            document.getElementById('generateReport').addEventListener('click', function() {
                generateReport();
            });
            
            // Export to Excel
            document.getElementById('exportExcel').addEventListener('click', function() {
                exportToExcel();
            });
            
            // Export to PDF
            document.getElementById('exportPDF').addEventListener('click', function() {
                exportToPDF();
            });
            
            // Save changes in edit modal
            document.getElementById('saveChangesBtn').addEventListener('click', function() {
                saveCaseChanges();
            });
            
            // Tab change event to refresh dashboard
            document.getElementById('dashboard-tab').addEventListener('shown.bs.tab', function() {
                updateDashboard();
            });
        }

        // Save new case
        function saveNewCase() {
            showLoadingSpinner(true);
            
            const newCase = {
                id: document.getElementById('caseId').value,
                date: document.getElementById('date').value,
                platform: document.getElementById('platform').value,
                branch: document.getElementById('branch').value,
                orderNumber: document.getElementById('orderNumber').value,
                customerName: document.getElementById('customerName').value,
                issueType: document.getElementById('issueType').value,
                orderValue: parseFloat(document.getElementById('orderValue').value),
                compensationValue: parseFloat(document.getElementById('compensationValue').value),
                responsibleParty: document.getElementById('responsibleParty').value,
                status: document.getElementById('status').value,
                actionTaken: document.getElementById('actionTaken').value,
                agentName: document.getElementById('agentName').value,
                dateClosed: document.getElementById('status').value === 'Closed' ? new Date().toISOString() : null,
                supportingFile: document.getElementById('supportingFile').value,
                remarks: document.getElementById('remarks').value,
                createdAt: new Date().toISOString()
            };
            
            // Add to array
            compensationCases.push(newCase);
            
            // Save to localStorage
            localStorage.setItem('compensationCases', JSON.stringify(compensationCases));
            
            // Reset form and generate new case ID
            document.getElementById('newCaseForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            generateCaseId();
            
            // Update UI with a slight delay to show the loading effect
            setTimeout(() => {
                loadCases();
                updateDashboard();
                updateLastUpdated();
                
                showLoadingSpinner(false);
                
                // Show success message
                showToast('Case saved successfully!', 'success');
                
                // Switch to dashboard tab
                const dashboardTab = new bootstrap.Tab(document.getElementById('dashboard-tab'));
                dashboardTab.show();
            }, 500);
        }

        // Load cases into table
        function loadCases(filteredCases = null) {
            const casesToDisplay = filteredCases || compensationCases;
            const tableBody = document.getElementById('casesTableBody');
            
            if (casesToDisplay.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="11" class="text-center">No cases found</td></tr>';
                document.getElementById('casesCount').textContent = '0 cases';
                return;
            }
            
            tableBody.innerHTML = '';
            
            // Sort cases by date (newest first)
            const sortedCases = [...casesToDisplay].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            sortedCases.forEach(caseItem => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${caseItem.id}</td>
                    <td>${formatDate(caseItem.date)}</td>
                    <td>${caseItem.platform}</td>
                    <td>${caseItem.branch}</td>
                    <td>${caseItem.orderNumber}</td>
                    <td>${caseItem.customerName}</td>
                    <td>${caseItem.issueType}</td>
                    <td>AED ${caseItem.compensationValue.toFixed(2)}</td>
                    <td><span class="status-badge status-${caseItem.status.toLowerCase()}">${caseItem.status}</span></td>
                    <td>${caseItem.agentName}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewCaseDetails('${caseItem.id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="editCase('${caseItem.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCase('${caseItem.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            document.getElementById('casesCount').textContent = `${casesToDisplay.length} cases`;
        }

        // Update dashboard
        function updateDashboard() {
            // Calculate statistics
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthCases = compensationCases.filter(caseItem => {
                const caseDate = new Date(caseItem.date);
                return caseDate.getMonth() === currentMonth && caseDate.getFullYear() === currentYear;
            });
            
            const openCases = compensationCases.filter(caseItem => caseItem.status === 'Open');
            const closedCases = compensationCases.filter(caseItem => caseItem.status === 'Closed');
            
            const totalCompensation = compensationCases.reduce((sum, caseItem) => sum + caseItem.compensationValue, 0);
            
            const resolutionRate = compensationCases.length > 0 
                ? ((closedCases.length / compensationCases.length) * 100).toFixed(1) 
                : 0;
            
            // Update stat cards with animation
            animateValue('totalCasesMonth', parseInt(document.getElementById('totalCasesMonth').textContent) || 0, monthCases.length, 500);
            animateValue('openCases', parseInt(document.getElementById('openCases').textContent) || 0, openCases.length, 500);
            
            document.getElementById('totalCompensation').textContent = `AED ${totalCompensation.toFixed(2)}`;
            document.getElementById('resolutionRate').textContent = `${resolutionRate}%`;
            
            // Update data count in navbar
            document.getElementById('dataCount').textContent = `Total Cases: ${compensationCases.length}`;
            
            // Update charts
            updatePlatformChart();
            updateBranchChart();
            updateStatusChart();
            updateIssueTypeChart();
            updateAgentPerformanceTable();
        }

        // Animate number changes
        function animateValue(id, start, end, duration) {
            const element = document.getElementById(id);
            const range = end - start;
            const increment = range / (duration / 10);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    element.textContent = end;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.round(current);
                }
            }, 10);
        }

        // Update platform chart
        function updatePlatformChart() {
            const ctx = document.getElementById('platformChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.platform) {
                charts.platform.destroy();
            }
            
            const platformCounts = {};
            compensationCases.forEach(caseItem => {
                platformCounts[caseItem.platform] = (platformCounts[caseItem.platform] || 0) + 1;
            });
            
            charts.platform = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(platformCounts),
                    datasets: [{
                        label: 'Cases by Platform',
                        data: Object.values(platformCounts),
                        backgroundColor: [
                            'rgba(230, 57, 70, 0.7)',
                            'rgba(168, 218, 220, 0.7)',
                            'rgba(241, 250, 238, 0.7)',
                            'rgba(29, 53, 87, 0.7)',
                            'rgba(255, 183, 77, 0.7)'
                        ],
                        borderColor: [
                            'rgba(230, 57, 70, 1)',
                            'rgba(168, 218, 220, 1)',
                            'rgba(241, 250, 238, 1)',
                            'rgba(29, 53, 87, 1)',
                            'rgba(255, 183, 77, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update branch chart
        function updateBranchChart() {
            const ctx = document.getElementById('branchChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.branch) {
                charts.branch.destroy();
            }
            
            const branchCounts = {};
            compensationCases.forEach(caseItem => {
                branchCounts[caseItem.branch] = (branchCounts[caseItem.branch] || 0) + 1;
            });
            
            charts.branch = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(branchCounts),
                    datasets: [{
                        label: 'Cases by Branch',
                        data: Object.values(branchCounts),
                        backgroundColor: [
                            'rgba(230, 57, 70, 0.7)',
                            'rgba(168, 218, 220, 0.7)',
                            'rgba(241, 250, 238, 0.7)',
                            'rgba(29, 53, 87, 0.7)',
                            'rgba(255, 183, 77, 0.7)',
                            'rgba(73, 80, 87, 0.7)',
                            'rgba(119, 140, 163, 0.7)',
                            'rgba(223, 230, 233, 0.7)'
                        ],
                        borderColor: [
                            'rgba(230, 57, 70, 1)',
                            'rgba(168, 218, 220, 1)',
                            'rgba(241, 250, 238, 1)',
                            'rgba(29, 53, 87, 1)',
                            'rgba(255, 183, 77, 1)',
                            'rgba(73, 80, 87, 1)',
                            'rgba(119, 140, 163, 1)',
                            'rgba(223, 230, 233, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Update status chart
        function updateStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.status) {
                charts.status.destroy();
            }
            
            const statusCounts = {};
            compensationCases.forEach(caseItem => {
                statusCounts[caseItem.status] = (statusCounts[caseItem.status] || 0) + 1;
            });
            
            charts.status = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        label: 'Status Breakdown',
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            'rgba(255, 193, 7, 0.7)',
                            'rgba(23, 162, 184, 0.7)',
                            'rgba(40, 167, 69, 0.7)',
                            'rgba(220, 53, 69, 0.7)',
                            'rgba(108, 117, 125, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 193, 7, 1)',
                            'rgba(23, 162, 184, 1)',
                            'rgba(40, 167, 69, 1)',
                            'rgba(220, 53, 69, 1)',
                            'rgba(108, 117, 125, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Update issue type chart
        function updateIssueTypeChart() {
            const ctx = document.getElementById('issueTypeChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (charts.issueType) {
                charts.issueType.destroy();
            }
            
            const issueTypeCounts = {};
            compensationCases.forEach(caseItem => {
                issueTypeCounts[caseItem.issueType] = (issueTypeCounts[caseItem.issueType] || 0) + 1;
            });
            
            // Sort and get top 5
            const sortedIssueTypes = Object.entries(issueTypeCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            charts.issueType = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedIssueTypes.map(item => item[0]),
                    datasets: [{
                        label: 'Top Issue Types',
                        data: sortedIssueTypes.map(item => item[1]),
                        backgroundColor: 'rgba(230, 57, 70, 0.7)',
                        borderColor: 'rgba(230, 57, 70, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update agent performance table
        function updateAgentPerformanceTable() {
            const agentPerformance = {};
            
            compensationCases.forEach(caseItem => {
                if (!agentPerformance[caseItem.agentName]) {
                    agentPerformance[caseItem.agentName] = {
                        casesHandled: 0,
                        closedCases: 0,
                        totalResolutionTime: 0
                    };
                }
                
                agentPerformance[caseItem.agentName].casesHandled++;
                
                if (caseItem.status === 'Closed' && caseItem.dateClosed) {
                    agentPerformance[caseItem.agentName].closedCases++;
                    
                    const createdDate = new Date(caseItem.createdAt);
                    const closedDate = new Date(caseItem.dateClosed);
                    const resolutionTime = Math.floor((closedDate - createdDate) / (1000 * 60 * 60 * 24)); // in days
                    
                    agentPerformance[caseItem.agentName].totalResolutionTime += resolutionTime;
                }
            });
            
            const tableBody = document.getElementById('agentPerformanceTable');
            tableBody.innerHTML = '';
            
            if (Object.keys(agentPerformance).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No data available</td></tr>';
                return;
            }
            
            Object.entries(agentPerformance).forEach(([agentName, performance]) => {
                const resolutionRate = performance.casesHandled > 0 
                    ? ((performance.closedCases / performance.casesHandled) * 100).toFixed(1) 
                    : 0;
                
                const avgResolutionTime = performance.closedCases > 0 
                    ? (performance.totalResolutionTime / performance.closedCases).toFixed(1) 
                    : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${agentName}</td>
                    <td>${performance.casesHandled}</td>
                    <td>${resolutionRate}%</td>
                    <td>${avgResolutionTime} days</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // View case details
        function viewCaseDetails(caseId) {
            const caseItem = compensationCases.find(c => c.id === caseId);
            if (!caseItem) return;
            
            const modal = new bootstrap.Modal(document.getElementById('caseDetailsModal'));
            const content = document.getElementById('caseDetailsContent');
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Case ID:</strong> ${caseItem.id}</p>
                        <p><strong>Date:</strong> ${formatDate(caseItem.date)}</p>
                        <p><strong>Platform:</strong> ${caseItem.platform}</p>
                        <p><strong>Branch:</strong> ${caseItem.branch}</p>
                        <p><strong>Order Number:</strong> ${caseItem.orderNumber}</p>
                        <p><strong>Customer Name:</strong> ${caseItem.customerName}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Issue Type:</strong> ${caseItem.issueType}</p>
                        <p><strong>Order Value:</strong> AED ${caseItem.orderValue.toFixed(2)}</p>
                        <p><strong>Compensation Value:</strong> AED ${caseItem.compensationValue.toFixed(2)}</p>
                        <p><strong>Responsible Party:</strong> ${caseItem.responsibleParty}</p>
                        <p><strong>Status:</strong> <span class="status-badge status-${caseItem.status.toLowerCase()}">${caseItem.status}</span></p>
                        <p><strong>Agent Name:</strong> ${caseItem.agentName}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Action Taken:</strong></p>
                        <p>${caseItem.actionTaken || 'No action taken yet'}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Remarks / Notes:</strong></p>
                        <p>${caseItem.remarks || 'No remarks'}</p>
                    </div>
                </div>
                ${caseItem.supportingFile ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Supporting File:</strong></p>
                        <a href="${caseItem.supportingFile}" target="_blank">View File</a>
                    </div>
                </div>
                ` : ''}
            `;
            
            currentEditingCaseId = caseId;
            modal.show();
        }

        // Edit case
        function editCase(caseId) {
            const caseItem = compensationCases.find(c => c.id === caseId);
            if (!caseItem) return;
            
            const modal = new bootstrap.Modal(document.getElementById('editCaseModal'));
            const form = document.getElementById('editCaseForm');
            
            form.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editCaseId" class="form-label">Case ID</label>
                        <input type="text" class="form-control" id="editCaseId" value="${caseItem.id}" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editDate" class="form-label">Date of Incident</label>
                        <input type="date" class="form-control" id="editDate" value="${caseItem.date}" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editPlatform" class="form-label">Platform</label>
                        <select class="form-select" id="editPlatform" required>
                            <option value="Noon" ${caseItem.platform === 'Noon' ? 'selected' : ''}>Noon</option>
                            <option value="Careem" ${caseItem.platform === 'Careem' ? 'selected' : ''}>Careem</option>
                            <option value="Smile" ${caseItem.platform === 'Smile' ? 'selected' : ''}>Smile</option>
                            <option value="Deliveroo" ${caseItem.platform === 'Deliveroo' ? 'selected' : ''}>Deliveroo</option>
                            <option value="Keita" ${caseItem.platform === 'Keita' ? 'selected' : ''}>Keita</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editBranch" class="form-label">Branch</label>
                        <select class="form-select" id="editBranch" required>
                            <option value="Hamdan" ${caseItem.branch === 'Hamdan' ? 'selected' : ''}>Hamdan</option>
                            <option value="Khaldia" ${caseItem.branch === 'Khaldia' ? 'selected' : ''}>Khaldia</option>
                            <option value="Shabiya 11" ${caseItem.branch === 'Shabiya 11' ? 'selected' : ''}>Shabiya 11</option>
                            <option value="Muroor" ${caseItem.branch === 'Muroor' ? 'selected' : ''}>Muroor</option>
                            <option value="Electra" ${caseItem.branch === 'Electra' ? 'selected' : ''}>Electra</option>
                            <option value="Barsha" ${caseItem.branch === 'Barsha' ? 'selected' : ''}>Barsha</option>
                            <option value="Satwa" ${caseItem.branch === 'Satwa' ? 'selected' : ''}>Satwa</option>
                            <option value="New Branch" ${caseItem.branch === 'New Branch' ? 'selected' : ''}>New Branch</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editOrderNumber" class="form-label">Order Number</label>
                        <input type="text" class="form-control" id="editOrderNumber" value="${caseItem.orderNumber}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editCustomerName" class="form-label">Customer Name / Number</label>
                        <input type="text" class="form-control" id="editCustomerName" value="${caseItem.customerName}" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editIssueType" class="form-label">Issue Type</label>
                        <select class="form-select" id="editIssueType" required>
                            <option value="Missing Item" ${caseItem.issueType === 'Missing Item' ? 'selected' : ''}>Missing Item</option>
                            <option value="Late Delivery" ${caseItem.issueType === 'Late Delivery' ? 'selected' : ''}>Late Delivery</option>
                            <option value="Wrong Order" ${caseItem.issueType === 'Wrong Order' ? 'selected' : ''}>Wrong Order</option>
                            <option value="Refund Request" ${caseItem.issueType === 'Refund Request' ? 'selected' : ''}>Refund Request</option>
                            <option value="Double Charge" ${caseItem.issueType === 'Double Charge' ? 'selected' : ''}>Double Charge</option>
                            <option value="Food Quality" ${caseItem.issueType === 'Food Quality' ? 'selected' : ''}>Food Quality</option>
                            <option value="Other" ${caseItem.issueType === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editResponsibleParty" class="form-label">Responsible Party</label>
                        <select class="form-select" id="editResponsibleParty" required>
                            <option value="Platform" ${caseItem.responsibleParty === 'Platform' ? 'selected' : ''}>Platform</option>
                            <option value="Restaurant" ${caseItem.responsibleParty === 'Restaurant' ? 'selected' : ''}>Restaurant</option>
                            <option value="Driver" ${caseItem.responsibleParty === 'Driver' ? 'selected' : ''}>Driver</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editOrderValue" class="form-label">Order Value (AED)</label>
                        <input type="number" class="form-control" id="editOrderValue" value="${caseItem.orderValue}" min="0" step="0.01" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editCompensationValue" class="form-label">Compensation Value (AED)</label>
                        <input type="number" class="form-control" id="editCompensationValue" value="${caseItem.compensationValue}" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="editStatus" class="form-label">Status</label>
                        <select class="form-select" id="editStatus" required>
                            <option value="Open" ${caseItem.status === 'Open' ? 'selected' : ''}>Open</option>
                            <option value="Pending" ${caseItem.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Approved" ${caseItem.status === 'Approved' ? 'selected' : ''}>Approved</option>
                            <option value="Rejected" ${caseItem.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                            <option value="Closed" ${caseItem.status === 'Closed' ? 'selected' : ''}>Closed</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="editAgentName" class="form-label">Agent Name</label>
                        <input type="text" class="form-control" id="editAgentName" value="${caseItem.agentName}" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="editActionTaken" class="form-label">Action Taken</label>
                        <textarea class="form-control" id="editActionTaken" rows="3">${caseItem.actionTaken || ''}</textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="editRemarks" class="form-label">Remarks / Notes</label>
                        <textarea class="form-control" id="editRemarks" rows="3">${caseItem.remarks || ''}</textarea>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="editSupportingFile" class="form-label">Supporting File / Screenshot</label>
                        <input type="text" class="form-control" id="editSupportingFile" value="${caseItem.supportingFile || ''}" placeholder="Enter file path or URL">
                    </div>
                </div>
            `;
            
            currentEditingCaseId = caseId;
            modal.show();
        }

        // Save case changes
        function saveCaseChanges() {
            const caseIndex = compensationCases.findIndex(c => c.id === currentEditingCaseId);
            if (caseIndex === -1) return;
            
            const originalStatus = compensationCases[caseIndex].status;
            const newStatus = document.getElementById('editStatus').value;
            
            compensationCases[caseIndex] = {
                ...compensationCases[caseIndex],
                date: document.getElementById('editDate').value,
                platform: document.getElementById('editPlatform').value,
                branch: document.getElementById('editBranch').value,
                orderNumber: document.getElementById('editOrderNumber').value,
                customerName: document.getElementById('editCustomerName').value,
                issueType: document.getElementById('editIssueType').value,
                orderValue: parseFloat(document.getElementById('editOrderValue').value),
                compensationValue: parseFloat(document.getElementById('editCompensationValue').value),
                responsibleParty: document.getElementById('editResponsibleParty').value,
                status: newStatus,
                actionTaken: document.getElementById('editActionTaken').value,
                agentName: document.getElementById('editAgentName').value,
                supportingFile: document.getElementById('editSupportingFile').value,
                remarks: document.getElementById('editRemarks').value,
                dateClosed: (originalStatus !== 'Closed' && newStatus === 'Closed') ? new Date().toISOString() : compensationCases[caseIndex].dateClosed,
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem('compensationCases', JSON.stringify(compensationCases));
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('editCaseModal')).hide();
            
            // Update UI
            loadCases();
            updateDashboard();
            updateLastUpdated();
            
            // Show success message
            showToast('Case updated successfully!', 'success');
        }

        // Delete case
        function deleteCase(caseId) {
            if (!confirm('Are you sure you want to delete this case?')) return;
            
            compensationCases = compensationCases.filter(c => c.id !== caseId);
            localStorage.setItem('compensationCases', JSON.stringify(compensationCases));
            
            // Update UI
            loadCases();
            updateDashboard();
            updateLastUpdated();
            
            // Show success message
            showToast('Case deleted successfully!', 'success');
        }

        // Apply filters
        function applyFilters() {
            const platform = document.getElementById('filterPlatform').value;
            const branch = document.getElementById('filterBranch').value;
            const status = document.getElementById('filterStatus').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            let filteredCases = compensationCases;
            
            if (platform) {
                filteredCases = filteredCases.filter(c => c.platform === platform);
            }
            
            if (branch) {
                filteredCases = filteredCases.filter(c => c.branch === branch);
            }
            
            if (status) {
                filteredCases = filteredCases.filter(c => c.status === status);
            }
            
            if (search) {
                filteredCases = filteredCases.filter(c => 
                    c.id.toLowerCase().includes(search) ||
                    c.orderNumber.toLowerCase().includes(search) ||
                    c.customerName.toLowerCase().includes(search)
                );
            }
            
            if (dateFrom) {
                filteredCases = filteredCases.filter(c => c.date >= dateFrom);
            }
            
            if (dateTo) {
                filteredCases = filteredCases.filter(c => c.date <= dateTo);
            }
            
            loadCases(filteredCases);
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('filterPlatform').value = '';
            document.getElementById('filterBranch').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            
            loadCases();
        }

        // Generate report
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const reportPeriod = document.getElementById('reportPeriod').value;
            
            let filteredCases = [...compensationCases];
            
            // Apply date filter based on period
            const now = new Date();
            let dateFrom, dateTo;
            
            switch (reportPeriod) {
                case 'today':
                    dateFrom = dateTo = now.toISOString().split('T')[0];
                    break;
                case 'week':
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay());
                    dateFrom = weekStart.toISOString().split('T')[0];
                    dateTo = now.toISOString().split('T')[0];
                    break;
                case 'month':
                    dateFrom = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                    dateTo = now.toISOString().split('T')[0];
                    break;
                case 'quarter':
                    const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                    dateFrom = quarterStart.toISOString().split('T')[0];
                    dateTo = now.toISOString().split('T')[0];
                    break;
                case 'year':
                    dateFrom = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];
                    dateTo = now.toISOString().split('T')[0];
                    break;
                case 'custom':
                    dateFrom = document.getElementById('reportDateFrom').value;
                    dateTo = document.getElementById('reportDateTo').value;
                    break;
            }
            
            if (dateFrom) {
                filteredCases = filteredCases.filter(c => c.date >= dateFrom);
            }
            
            if (dateTo) {
                filteredCases = filteredCases.filter(c => c.date <= dateTo);
            }
            
            // Generate report content based on type
            let reportContent = '';
            
            switch (reportType) {
                case 'summary':
                    reportContent = generateSummaryReport(filteredCases, dateFrom, dateTo);
                    break;
                case 'detailed':
                    reportContent = generateDetailedReport(filteredCases, dateFrom, dateTo);
                    break;
                case 'platform':
                    reportContent = generatePlatformReport(filteredCases, dateFrom, dateTo);
                    break;
                case 'branch':
                    reportContent = generateBranchReport(filteredCases, dateFrom, dateTo);
                    break;
                case 'agent':
                    reportContent = generateAgentReport(filteredCases, dateFrom, dateTo);
                    break;
            }
            
            // Display report
            document.getElementById('reportContent').innerHTML = reportContent;
            document.getElementById('reportPreview').style.display = 'block';
        }

        // Generate summary report
        function generateSummaryReport(cases, dateFrom, dateTo) {
            const totalCases = cases.length;
            const totalCompensation = cases.reduce((sum, c) => sum + c.compensationValue, 0);
            const openCases = cases.filter(c => c.status === 'Open').length;
            const closedCases = cases.filter(c => c.status === 'Closed').length;
            const resolutionRate = totalCases > 0 ? ((closedCases / totalCases) * 100).toFixed(1) : 0;
            
            const platformCounts = {};
            const branchCounts = {};
            const issueTypeCounts = {};
            
            cases.forEach(c => {
                platformCounts[c.platform] = (platformCounts[c.platform] || 0) + 1;
                branchCounts[c.branch] = (branchCounts[c.branch] || 0) + 1;
                issueTypeCounts[c.issueType] = (issueTypeCounts[c.issueType] || 0) + 1;
            });
            
            return `
                <h4>Summary Report</h4>
                <p><strong>Period:</strong> ${formatDate(dateFrom)} to ${formatDate(dateTo)}</p>
                
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h5 class="card-title">Total Cases</h5>
                                <h2 class="text-primary">${totalCases}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h5 class="card-title">Total Compensation</h5>
                                <h2 class="text-success">AED ${totalCompensation.toFixed(2)}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h5 class="card-title">Open Cases</h5>
                                <h2 class="text-warning">${openCases}</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body">
                                <h5 class="card-title">Resolution Rate</h5>
                                <h2 class="text-info">${resolutionRate}%</h2>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-4">
                        <h5>Cases by Platform</h5>
                        <ul class="list-group">
                            ${Object.entries(platformCounts).map(([platform, count]) => 
                                `<li class="list-group-item d-flex justify-content-between">
                                    <span>${platform}</span>
                                    <span class="badge bg-primary rounded-pill">${count}</span>
                                </li>`
                            ).join('')}
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h5>Cases by Branch</h5>
                        <ul class="list-group">
                            ${Object.entries(branchCounts).map(([branch, count]) => 
                                `<li class="list-group-item d-flex justify-content-between">
                                    <span>${branch}</span>
                                    <span class="badge bg-primary rounded-pill">${count}</span>
                                </li>`
                            ).join('')}
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h5>Top Issue Types</h5>
                        <ul class="list-group">
                            ${Object.entries(issueTypeCounts)
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 5)
                                .map(([issue, count]) => 
                                    `<li class="list-group-item d-flex justify-content-between">
                                        <span>${issue}</span>
                                        <span class="badge bg-primary rounded-pill">${count}</span>
                                    </li>`
                                ).join('')}
                        </ul>
                    </div>
                </div>
            `;
        }

        // Generate detailed report
        function generateDetailedReport(cases, dateFrom, dateTo) {
            return `
                <h4>Detailed Report</h4>
                <p><strong>Period:</strong> ${formatDate(dateFrom)} to ${formatDate(dateTo)}</p>
                
                <div class="table-responsive mt-4">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Case ID</th>
                                <th>Date</th>
                                <th>Platform</th>
                                <th>Branch</th>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th>Issue Type</th>
                                <th>Compensation</th>
                                <th>Status</th>
                                <th>Agent</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cases.map(c => `
                                <tr>
                                    <td>${c.id}</td>
                                    <td>${formatDate(c.date)}</td>
                                    <td>${c.platform}</td>
                                    <td>${c.branch}</td>
                                    <td>${c.orderNumber}</td>
                                    <td>${c.customerName}</td>
                                    <td>${c.issueType}</td>
                                    <td>AED ${c.compensationValue.toFixed(2)}</td>
                                    <td><span class="status-badge status-${c.status.toLowerCase()}">${c.status}</span></td>
                                    <td>${c.agentName}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Generate platform report
        function generatePlatformReport(cases, dateFrom, dateTo) {
            const platformData = {};
            
            cases.forEach(c => {
                if (!platformData[c.platform]) {
                    platformData[c.platform] = {
                        cases: 0,
                        compensation: 0,
                        openCases: 0,
                        closedCases: 0
                    };
                }
                
                platformData[c.platform].cases++;
                platformData[c.platform].compensation += c.compensationValue;
                
                if (c.status === 'Open') {
                    platformData[c.platform].openCases++;
                } else if (c.status === 'Closed') {
                    platformData[c.platform].closedCases++;
                }
            });
            
            return `
                <h4>Platform Performance Report</h4>
                <p><strong>Period:</strong> ${formatDate(dateFrom)} to ${formatDate(dateTo)}</p>
                
                <div class="table-responsive mt-4">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Platform</th>
                                <th>Total Cases</th>
                                <th>Total Compensation</th>
                                <th>Open Cases</th>
                                <th>Closed Cases</th>
                                <th>Resolution Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(platformData).map(([platform, data]) => {
                                const resolutionRate = data.cases > 0 
                                    ? ((data.closedCases / data.cases) * 100).toFixed(1) 
                                    : 0;
                                
                                return `
                                    <tr>
                                        <td>${platform}</td>
                                        <td>${data.cases}</td>
                                        <td>AED ${data.compensation.toFixed(2)}</td>
                                        <td>${data.openCases}</td>
                                        <td>${data.closedCases}</td>
                                        <td>${resolutionRate}%</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Generate branch report
        function generateBranchReport(cases, dateFrom, dateTo) {
            const branchData = {};
            
            cases.forEach(c => {
                if (!branchData[c.branch]) {
                    branchData[c.branch] = {
                        cases: 0,
                        compensation: 0,
                        openCases: 0,
                        closedCases: 0
                    };
                }
                
                branchData[c.branch].cases++;
                branchData[c.branch].compensation += c.compensationValue;
                
                if (c.status === 'Open') {
                    branchData[c.branch].openCases++;
                } else if (c.status === 'Closed') {
                    branchData[c.branch].closedCases++;
                }
            });
            
            return `
                <h4>Branch Performance Report</h4>
                <p><strong>Period:</strong> ${formatDate(dateFrom)} to ${formatDate(dateTo)}</p>
                
                <div class="table-responsive mt-4">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Branch</th>
                                <th>Total Cases</th>
                                <th>Total Compensation</th>
                                <th>Open Cases</th>
                                <th>Closed Cases</th>
                                <th>Resolution Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(branchData).map(([branch, data]) => {
                                const resolutionRate = data.cases > 0 
                                    ? ((data.closedCases / data.cases) * 100).toFixed(1) 
                                    : 0;
                                
                                return `
                                    <tr>
                                        <td>${branch}</td>
                                        <td>${data.cases}</td>
                                        <td>AED ${data.compensation.toFixed(2)}</td>
                                        <td>${data.openCases}</td>
                                        <td>${data.closedCases}</td>
                                        <td>${resolutionRate}%</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Generate agent report
        function generateAgentReport(cases, dateFrom, dateTo) {
            const agentData = {};
            
            cases.forEach(c => {
                if (!agentData[c.agentName]) {
                    agentData[c.agentName] = {
                        casesHandled: 0,
                        compensation: 0,
                        openCases: 0,
                        closedCases: 0,
                        totalResolutionTime: 0
                    };
                }
                
                agentData[c.agentName].casesHandled++;
                agentData[c.agentName].compensation += c.compensationValue;
                
                if (c.status === 'Open') {
                    agentData[c.agentName].openCases++;
                } else if (c.status === 'Closed') {
                    agentData[c.agentName].closedCases++;
                    
                    if (c.dateClosed) {
                        const createdDate = new Date(c.createdAt);
                        const closedDate = new Date(c.dateClosed);
                        const resolutionTime = Math.floor((closedDate - createdDate) / (1000 * 60 * 60 * 24)); // in days
                        
                        agentData[c.agentName].totalResolutionTime += resolutionTime;
                    }
                }
            });
            
            return `
                <h4>Agent Performance Report</h4>
                <p><strong>Period:</strong> ${formatDate(dateFrom)} to ${formatDate(dateTo)}</p>
                
                <div class="table-responsive mt-4">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Agent Name</th>
                                <th>Cases Handled</th>
                                <th>Total Compensation</th>
                                <th>Open Cases</th>
                                <th>Closed Cases</th>
                                <th>Resolution Rate</th>
                                <th>Avg. Resolution Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(agentData).map(([agent, data]) => {
                                const resolutionRate = data.casesHandled > 0 
                                    ? ((data.closedCases / data.casesHandled) * 100).toFixed(1) 
                                    : 0;
                                
                                const avgResolutionTime = data.closedCases > 0 
                                    ? (data.totalResolutionTime / data.closedCases).toFixed(1) 
                                    : 0;
                                
                                return `
                                    <tr>
                                        <td>${agent}</td>
                                        <td>${data.casesHandled}</td>
                                        <td>AED ${data.compensation.toFixed(2)}</td>
                                        <td>${data.openCases}</td>
                                        <td>${data.closedCases}</td>
                                        <td>${resolutionRate}%</td>
                                        <td>${avgResolutionTime} days</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Export to Excel
        function exportToExcel() {
            // Create CSV content
            let csvContent = "Case ID,Date,Platform,Branch,Order Number,Customer Name,Issue Type,Order Value,Compensation Value,Responsible Party,Status,Action Taken,Agent Name,Date Closed,Supporting File,Remarks\n";
            
            compensationCases.forEach(c => {
                csvContent += `${c.id},${c.date},${c.platform},${c.branch},${c.orderNumber},${c.customerName},${c.issueType},${c.orderValue},${c.compensationValue},${c.responsibleParty},${c.status},"${c.actionTaken}",${c.agentName},${c.dateClosed || ''},${c.supportingFile || ''},"${c.remarks}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `compensation_cases_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('Exported to Excel successfully!', 'success');
        }

        // Export to PDF
        function exportToPDF() {
            // This is a simplified version - in a real implementation, you would use a library like jsPDF
            // For now, we'll create a printable version of the report
            const reportContent = document.getElementById('reportContent').innerHTML;
            
            if (!reportContent) {
                showToast('Please generate a report first', 'warning');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Crispy Chicken - Compensation Report</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .table { width: 100%; border-collapse: collapse; }
                            .table th, .table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            .table th { background-color: #f2f2f2; }
                            .stat-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
                            @media print { .no-print { display: none; } }
                        </style>
                    </head>
                    <body>
                        <h1>Crispy Chicken - Compensation Report</h1>
                        <p>Generated on: ${new Date().toLocaleString()}</p>
                        ${reportContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            showToast('PDF export initiated', 'success');
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const now = new Date();
            const formattedTime = now.toLocaleString();
            document.getElementById('lastUpdated').textContent = `Last Updated: ${formattedTime}`;
            document.getElementById('footerLastUpdated').textContent = formattedTime;
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div id="${toastId}" class="toast custom-toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'danger' ? 'danger' : 'info'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        // Show/hide loading spinner
        function showLoadingSpinner(show) {
            const spinner = document.querySelector('.loading-spinner');
            spinner.style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>
